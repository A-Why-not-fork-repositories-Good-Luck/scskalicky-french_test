<!DOCTYPE html>
<html>
  <head>
  <title>French Test</title>
  <script src = "audio_stimuli.js" type = 'text/javascript'></script>
  <script src = 'helper_functions.js' type = 'text/javascript'></script>
  <script src = "jspsych/jspsych.js"></script>
  <script src = "jspsych/plugin-html-keyboard-response.js"></script>
  <script src = "jspsych/plugin-initialize-microphone.js"></script>
  <script src = "jspsych/plugin-html-audio-response.js"></script>
  <script src = "jspsych/plugin-audio-keyboard-response.js"></script>
  <script src = "jspsych/plugin-html-button-response.js"></script>
  <script src="jspsych/plugin-preload.js"></script>
  <script type="text/javascript" src="jquery-3.6.0.js"></script>
  <link href = "jspsych/jspsych.css" rel="stylesheet" type = "text/css" />
  </head>
  <body></body>
  <script>
  const jsPsych = initJsPsych({
    on_finish: function(data){
      //jsPsych.data.displayData();
     // console.log('finished')
      // save data to csv
      saveData(id, jsPsych.data.get().csv())
      window.location = "https://www.duolingo.com";
    }
  });
  </script>
</html>

<script>

//random id for testing
const id = jsPsych.randomization.sampleWithoutReplacement(['Stephen', 'stephen'], 1)
console.log(id);

console.log(audio);

// currently cannot understand why I cannot import variable from another script. fucking annoying. 

jsPsych.data.addProperties({subject: id})

// save all data at the end
function saveData(name, data){
  var xhr = new XMLHttpRequest();
  xhr.open('POST', 'write_data.php');
  xhr.setRequestHeader('Content-Type', 'application/json');
  xhr.send(JSON.stringify({filedata: data}));
}


const timeline = []

var preload = {
    type: jsPsychPreload,
    auto_preload: true
}

timeline.push(preload)

const preamble = {
    type: jsPsychHtmlButtonResponse,
    stimulus: 'Please connect your microphone to the computer. <br> We recommend using a pair of headphones with a microphone. <br>Once you have connected your microphone & headphones to the computer, click this button to prompt browser access to your microphone',
    choices: ['Add Microphone']
}

timeline.push(preamble)

const ready_microphone = {
    type: jsPsychInitializeMicrophone
}

timeline.push(ready_microphone)

const test_audio_instructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: 'Let\'s make sure the test can hear you. Please click the button below and speak into your microphone. <br> You will be able to review your recording afterwards. <br> Please do not continue the test until you are able to hear a recording of yourself played back to you.',
  choices: ['Begin Recording']
}

timeline.push(test_audio_instructions)

const test_audio = {
    type: jsPsychHtmlAudioResponse,
    recording_duration: 10000,
    stimulus: 'RECORDING...',
    allow_playback: true,
    show_done_button: true,
    record_again_button_label: 'Record Again'
}

// eventually want to flush this response from the data to save space. 
timeline.push(test_audio)

const recording_passed = {
    type: jsPsychHtmlButtonResponse,
    stimulus: 'Thank you. You have indicated that you are able to hear the recording played back to you. <br> Press the button to continue the test.',
    choices: ['Continue']
}

timeline.push(recording_passed);


const prepare_trials = {
  type: jsPsychHtmlButtonResponse,
  stimulus: 'This test requires you to participate in some short back-and-forth conversations. You will first hear a speaker say something, and then you will record your response. You will then hear the speaker reply, and you will then record your response. The test will start recording you as soon as you click the "record response" button. You will only hear the audio once.',
  choices: ['LET\'S GO!']
}

timeline.push(prepare_trials)



const conversations = {
  timeline: [
  {type: jsPsychHtmlButtonResponse,
  stimulus: 'You are about to begin a NEW conversation.',
  choices: ['BEGIN']},


    {type: jsPsychHtmlButtonResponse,
      stimulus: '',
    choices: ['PLAY AUDIO_1']},
    
    {type: jsPsychAudioKeyboardResponse,
    stimulus: jsPsych.timelineVariable('turn1'),
    data: jsPsych.timelineVariable("data"),
    choices: 'NO_KEYS',
    trial_ends_after_audio: true},
    
    {type: jsPsychHtmlButtonResponse,
      stimulus: '',
    choices: ['RECORD RESPONSE']},

    {type: jsPsychHtmlAudioResponse,
    stimulus: 'RECORDING...',
    recording_duration: 5000,
    show_done_button: true,
    done_button_label: "Finish Recording",
    // save the audio to the server then remove from active data object
    // this is necessary because the audio data takes up much memory
    on_finish: function(data){
      purgeAudio(data)
      
      // create a random id for the specific audio file.
   //   audio_id = (id).toString().concat('_audio-').concat(Date.now().toString().concat('_').concat(Math.floor(Math.random()*9999)).toString())
    //  console.log(audio_id);
      // call the php script
     // $.ajax ({
			//			url: "save_audio.php",
				//		type: "POST",
					//	data: {audio_base64: data.response, identifier: audio_id},
          //  dataType: 'text',
         // });
     // replace the base64 in the jsP data with the audio_id
   // data.response = audio_id;
   // 
  }},
    
    {type: jsPsychHtmlButtonResponse,
      stimulus: '',
    choices: ['PLAY AUDIO_2']},
    
    {type: jsPsychAudioKeyboardResponse,
      stimulus: jsPsych.timelineVariable('turn2'),
      data: jsPsych.timelineVariable("data"),
    choices: 'NO_KEYS',
    trial_ends_after_audio: true},

    {type: jsPsychHtmlButtonResponse,
      stimulus: '',
    choices: ['RECORD RESPONSE']},

    {type: jsPsychHtmlAudioResponse,
    stimulus: 'RECORDING...',
    recording_duration: 5000,
    show_done_button: true,
    done_button_label: "Finish Recording",
    // save the audio to the server then remove from active data object
    // this is necessary because the audio data takes up much memory
    on_finish: function(data){
      // create a random id for the specific audio file.
      audio_id = (id).toString().concat('_audio-').concat(Date.now().toString().concat('_').concat(Math.floor(Math.random()*9999)).toString())
      console.log(audio_id);
      // call the php script
      $.ajax ({
						url: "save_audio.php",
						type: "POST",
						data: {audio_base64: data.response, identifier: audio_id},
            dataType: 'text',
          });
     // replace the base64 in the jsP data with the audio_id
    data.response = audio_id;
    }},

    {type: jsPsychHtmlButtonResponse,
      stimulus: '',
    choices: ['PLAY AUDIO_3']},
    
    {type: jsPsychAudioKeyboardResponse,
      stimulus: jsPsych.timelineVariable('turn3'),
      data: jsPsych.timelineVariable("data"),
    choices: 'NO_KEYS',
    trial_ends_after_audio: true},

    {type: jsPsychHtmlButtonResponse,
      stimulus: '',
    choices: ['RECORD RESPONSE']},

    {type: jsPsychHtmlAudioResponse,
    stimulus: 'RECORDING...',
    recording_duration: 5000,
    show_done_button: true,
    done_button_label: "Finish Recording",
    // save the audio to the server then remove from active data object
    // this is necessary because the audio data takes up much memory
    on_finish: function(data){
      // create a random id for the specific audio file.
      audio_id = (id).toString().concat('_audio-').concat(Date.now().toString().concat('_').concat(Math.floor(Math.random()*9999)).toString())
      console.log(audio_id);
      // call the php script
      $.ajax ({
						url: "save_audio.php",
						type: "POST",
						data: {audio_base64: data.response, identifier: audio_id},
            dataType: 'text',
          });
     // replace the base64 in the jsP data with the audio_id
    data.response = audio_id;
    }},

    {type: jsPsychHtmlKeyboardResponse,
      stimulus: "LOADING NEXT ITEM...",
      trial_duration: 2500,
      choices: "NO_KEYS"
    }
  
  
 ], timeline_variables: audio}

 timeline.push(conversations)

 var end = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: 'Press the spacebar to end the test',
  choices: ' '
 }
 
 timeline.push(end)
 

jsPsych.run(timeline);
</script>