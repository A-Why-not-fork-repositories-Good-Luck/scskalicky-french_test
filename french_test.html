<!DOCTYPE html>
<html>
  <head>
  <title>French Test</title>
  <script type = "text/javascript" src="jquery-3.6.0.js"></script>
  <script id = 'stimuli'></script>
  <script>
  var stable = "stimuli.js?="
  var dynamic = Date.now()
  var parent = document.getElementById("stimuli")
  var someScriptElement = document.createElement("script")
  someScriptElement.setAttribute("src", stable + dynamic)
  stimuli.appendChild(someScriptElement)
  </script>
  <script id = "helper"></script>
  <script>
    // force reload of stimuli pages (for development.)
    var stable = "helper_functions.js?="
    var dynamic = Date.now()
    var parent = document.getElementById("helper")
    var someScriptElement = document.createElement("script")
    someScriptElement.setAttribute("src", stable + dynamic)
    helper.appendChild(someScriptElement)
    </script>
  <script src = "jspsych/jspsych.js"></script>
  <script src = "jspsych/plugin-html-keyboard-response.js"></script>
  <script src = "jspsych/plugin-initialize-microphone.js"></script>
  <script src = "jspsych/plugin-html-audio-response.js"></script>
  <script src = "jspsych/plugin-audio-keyboard-response.js"></script>
  <script src = "jspsych/plugin-audio-button-response.js"></script>
  <script src = "jspsych/plugin-html-button-response.js"></script>
  <script src = "jspsych/plugin-image-button-response.js"></script>
  <script src = "jspsych/plugin-image-keyboard-response.js"></script>
  <script src = "jspsych/plugin-survey-multi-select1.js"></script>
  <script src = "jspsych/plugin-survey-multi-choice1.js"></script>
  <script src = "jspsych/plugin-survey-html-form.js"></script>
  <script src = "jspsych/plugin-instructions.js"></script>
  <script src = "jspsych/plugin-cloze19.js"></script>
  <script src = "jspsych/plugin-survey-text.js"></script>
  <script src="jspsych/plugin-preload.js"></script>
  <link href = "jspsych/jspsych.css" rel="stylesheet" type = "text/css" />
  <script src = 'stimuli.js' type = 'text/javascript'></script>   
  </head>
  <body></body>  
  <script>
  const jsPsych = initJsPsych({
    on_finish: function(data){
      jsPsych.data.displayData();
     // console.log('finished')
      // save data to csv
      saveData(jsPsych.data.get().select('subject').values[0].Q0, jsPsych.data.get().csv())
     // window.location = "https://www.duolingo.com";
    }
  });
  </script>
</html>

<script>
const timeline = []

/*
Trials for recording audio. Might need to make separate ones for story completion and CA. Or adjust the stimuli substring to be appropriate.
*/
const record_response_button = {
    type: jsPsychHtmlButtonResponse,
    stimulus: '',
  choices: ['RECORD RESPONSE']
};

// will be changed to get from URL variable. 
var get_subject = {
  type: jsPsychSurveyText,
  questions: [{prompt: 'Please enter subject id'}],
  on_finish: function(data){
    jsPsych.data.addProperties({subject: data.response})
    console.log(jsPsych.data.get().select('subject').values[0].Q0)
    //jsPsych.data.get().select('subject')[0].values[0].Q0
  }
}
timeline.push(get_subject)

/* activate microphone and ensure participants can hear themselves being recorded.  */

// explain microphone connection
const prepare_microphone = {
    type: jsPsychHtmlButtonResponse,
    stimulus: 'Please connect your microphone to the computer. <br> We recommend using a pair of headphones with a microphone. <br>Once you have connected your microphone & headphones to the computer, click this button to prompt browser access to your microphone',
    choices: ['Add Microphone'],
}
//timeline.push(prepare_microphone)

// prompt for permission and initialise microphone
const ready_microphone = {
    type: jsPsychInitializeMicrophone
}
timeline.push(ready_microphone)

// explain to participants they need to make sure they can hear themselves. 
const test_audio_instructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: 'Let\'s make sure the test can hear you. Please click the button below and speak into your microphone for a few seconds. <br> Afterwards, you will be able to pleay your recording. <br>Please make sure that you can hear your recording. If not, please make sure you microphone is working properly and try again. <br> Please do not continue the test until you are able to hear a recording of yourself played back to you.',
  choices: ['Begin Recording']
}
//timeline.push(test_audio_instructions)

// allow recording and playback, recording limited to 10 seconds. 
const test_audio = {
    type: jsPsychHtmlAudioResponse,
    recording_duration: 10000,
    stimulus: 'RECORDING...',
    allow_playback: true,
    show_done_button: true,
    record_again_button_label: 'Record Again',
    on_finish: function(data){
      data.response = 'sanitized'}
}
//timeline.push(test_audio)

// honor system - participants will click to move on. 
const recording_passed = {
    type: jsPsychHtmlButtonResponse,
    stimulus: 'Thank you. You have indicated that you are able to hear yourself in the recording. <br> Press Continue when you are ready to continue the test.',
    choices: ['Continue'],
}
//timeline.push(recording_passed);

/***** STORY COMPLETION BLOCK *********
These questions involve participants looking at a series of images with which they will base a story. The images will be displayed for a fixed period of time (30 seconds), after which participants will have 2 minutes to orally tell their story based on the pictures. 
*/

/* Story Completion Part 1 - single image of a park
- 30 seconds to prepare
- 2 minutes for response
- size images to be w800xh600
- one trial so do not need timeline variables. 
*/

var SC1_preload = {
  type: jsPsychPreload,
  images: 'image/park1.jpg'
}
//timeline.push(SC1_preload)

var story_completion_instructions_p1 = {
type: jsPsychInstructions,
pages: ['On the next screen you will see an image depicting a scene.',
'Your task is to describe what you see in the picture.',
'Provide as many details as you can to describe the picture as best you can.',
'You will have 30 seconds to study the images and plan your story. Then you will have 2 minutes to speak your response.',
'If you forget some words, you can use English.'],
  show_clickable_nav: true
}

//timeline.push(story_completion_instructions_p1)

var SC1_trials = {
  timeline: [
    {type: jsPsychHtmlButtonResponse,
    stimulus: 'Once you click this button, you will have 30 seconds to study the picture and prepare your response',
    choices: ["See Picture"]},

    {type: jsPsychImageButtonResponse,
      stimulus: 'image/park1.jpg',
      trial_duration: 10000,
      stimulus_height: 600,
      stimulus_width: 800,
      data: jsPsych.timelineVariable('data'),
      on_finish: function(data){
        data.stim_id = 'park1'
      },
      choices: ["I'm Ready"]
    },

    // simulate a countdown for recording to start
  {type: jsPsychHtmlKeyboardResponse,
    stimulus: 'Begin speaking your answer in 3...',
    choices: 'NO_KEYS',
    on_finish: function(data){
        data.stim_id = 'park1'
      },
    trial_duration: 1050
  },
  
  // simulate a countdown for recording to start
  {type: jsPsychHtmlKeyboardResponse,
    stimulus: 'Begin speaking your answer in 2...',
    choices: 'NO_KEYS',
    on_finish: function(data){
        data.stim_id = 'park1'
      },
    trial_duration: 1050
  },
  
  // simulate a countdown for recording to start
  {type: jsPsychHtmlKeyboardResponse,
    stimulus: 'Begin speaking your answer in 1...',
    choices: 'NO_KEYS',
    on_finish: function(data){
        data.stim_id = 'park1'
      },
    trial_duration: 1050
  },

  // record answer 
  {
    type: jsPsychHtmlAudioResponse,
    stimulus: 'RECORDING...',
    recording_duration: 5000,
    show_done_button: true,
    done_button_label: "Finish Recording",
    // save audio
    on_finish: function(data){
        data.stim_id = 'park1';
        //subject name
      purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
      // audio file name
      jsPsych.data.get().last(5).values()[0].stimulus.substring(6), 
      // current js data object
      data),
      console.log(jsPsych.data.get().last(5).values()[0].stimulus.substring(6))
}}
  ]
}
//timeline.push(SC1_trials)

/* Story Completion Part 2 - six-panel images making a story
- 30 seconds to prepare
- 2 minutes for response
- size images to be w600xh800
- 1 trial so no need for timeline variables. 
*/

var SC2_preload = {
  type: jsPsychPreload,
  images: 'image/sixpanel2.jpg'
}
//timeline.push(SC2_preload)

var SC2_instructions = {
  type: jsPsychInstructions,
  pages: ['On the next screen you will see six images as part of a story.',
          'Your task is to describe what is happening in each box.',
          'Provide as many details as possible to make the story interesting.',
          'You will have 30 seconds to study the images and plan your story. Then you will have 2 minutes to speak your response.',
          'Be sure to tell us your story with as many interesting details as you can.',
          'If you forget some words, you can use English.',
],
  show_clickable_nav: true
}
//timeline.push(SC2_instructions)

var SC2_trials = {
  timeline: [
    {type: jsPsychHtmlButtonResponse,
    stimulus: 'Once you click this button, you will have 30 seconds to study the picture and prepare your response',
    choices: ["See Picture"]},

    {type: jsPsychImageButtonResponse,
      stimulus: 'image/sixpanel1.jpg',
      trial_duration: 10000,
      stimulus_height: 800,
      stimulus_width: 600,
      on_finish: function(data){
        data.stim_id = 'sixpanel1'},
      choices: ["I'm Ready"]
    },
    
    // simulate a countdown for recording to start
  {type: jsPsychHtmlKeyboardResponse,
    stimulus: 'Begin speaking your answer in 3...',
    choices: 'NO_KEYS',
    on_finish: function(data){
        data.stim_id = 'sixpanel1'},
    trial_duration: 1050
  },
  
  // simulate a countdown for recording to start
  {type: jsPsychHtmlKeyboardResponse,
    stimulus: 'Begin speaking your answer in 2...',
    choices: 'NO_KEYS',
    on_finish: function(data){
        data.stim_id = 'sixpanel1'},
    trial_duration: 1050
  },
  
  // simulate a countdown for recording to start
  {type: jsPsychHtmlKeyboardResponse,
    stimulus: 'Begin speaking your answer in 1...',
    choices: 'NO_KEYS',
    on_finish: function(data){
        data.stim_id = 'sixpanel1'},
    trial_duration: 1050
  },

    // record answer 
  {
    type: jsPsychHtmlAudioResponse,
    stimulus: 'RECORDING...',
    recording_duration: 5000,
    show_done_button: true,
    done_button_label: "Finish Recording",
    // save audio
    on_finish: function(data){
        data.stim_id = 'sixpanel1';
        //subject name
      purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
      // audio file name
      jsPsych.data.get().last(5).values()[0].stimulus.substring(6), 
      // current js data object
      data),
      console.log(jsPsych.data.get().last(5).values()[0].stimulus.substring(6))
}}
  ]
}
//timeline.push(SC2_trials)

/* Story Completion Part 3 - story of Max: before, now, and after.
- 30 seconds to prepare
- 2 minutes for response
- size images to be w800xh600
*/


var SC3_preload = {
  type: jsPsychPreload,
  images: 'image/max1.jpg'
}
//timeline.push(SC3_preload)

var SC3_instructions = {
  type: jsPsychInstructions,
  pages: ['On the next screen you will see an image which tells the story of the child Max.',
        'Study the picture and imagine a) what happened <b>before</b>, b) what is happening <b>now</b>, and c) what <b>will</b> happen.',
        'Your task is to tell Max\'s story.',
        'You will have 30 seconds to study the image and plan your story. Then you will have 2 minutes to speak your response.',
        ' Begin by saying the title and tell us your story with as many interesting details as you can.',
        'If you forget some words, you can use English.',
],
  show_clickable_nav: true
}

//timeline.push(SC3_instructions);

var SC3_trials = {
  timeline: [
    {type: jsPsychHtmlButtonResponse,
    stimulus: 'Once you click this button, you will have 30 seconds to study the picture and prepare your response',
    choices: ["See Picture"]},

    {type: jsPsychImageButtonResponse,
      stimulus: 'image/max1.jpg',
      trial_duration: 10000,
      stimulus_height: 800,
      stimulus_width: 1000,
      choices: ["I'm Ready"],
      on_finish: function(data){
        data.stim_id = 'max1.jpg'
      }
    },
    // simulate a countdown for recording to start
  {type: jsPsychHtmlKeyboardResponse,
    stimulus: 'Begin speaking your answer in 3...',
    choices: 'NO_KEYS',
    on_finish: function(data){
        data.stim_id = 'max1.jpg'},
    trial_duration: 1050
  },
  
  // simulate a countdown for recording to start
  {type: jsPsychHtmlKeyboardResponse,
    stimulus: 'Begin speaking your answer in 2...',
    choices: 'NO_KEYS',
    on_finish: function(data){
        data.stim_id = 'max1.jpg'},
    trial_duration: 1050
  },
  
  // simulate a countdown for recording to start
  {type: jsPsychHtmlKeyboardResponse,
    stimulus: 'Begin speaking your answer in 1...',
    choices: 'NO_KEYS',
    on_finish: function(data){
      data.stim_id = 'max1.jpg'},
    trial_duration: 1050
  },

  {
    type: jsPsychHtmlAudioResponse,
    stimulus: 'RECORDING...',
    recording_duration: 5000,
    show_done_button: true,
    done_button_label: "Finish Recording",
    // save audio
    on_finish: function(data){
      data.stim_id = 'max1.jpg';
      //subject name
      purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
      // audio file name
      jsPsych.data.get().last(5).values()[0].stimulus.substring(6), 
      // current js data object
      data),
    console.log(jsPsych.data.get().last(5).values()[0].stimulus.substring(6))
}}
  ]
}

//timeline.push(SC3_trials)

/* Story Completion Part 4 - unrelated picture story.
- 60 seconds to prepare
- 2 minutes for response
- size images to be w600xh800
- is there only one image? Will we just re-use the same img? 
*/

var SC4_preload = {
  type: jsPsychPreload,
  images: 'image/unrelated1.jpg'
}
timeline.push(SC4_preload)

var SC4_instructions = {
  type: jsPsychInstructions,
  pages: ['On the next screen you will see six pictures of different things.',
        'Your task is to narrate a story which includes all the elements depicted by the pictures.',
        'You must use all of the pictures that you see, but you can also add extra information.',
        'You will have 60 seconds to study the pictures. Then you will have 2 minutes to speak your response.',
        'If you forget some words, you can use English.',
],
  show_clickable_nav: true
}
timeline.push(SC4_instructions);

var SC4_trials = {
  timeline: [
    {type: jsPsychHtmlButtonResponse,
    stimulus: 'Once you click this button, you will have 60 seconds to study the picture and prepare your response',
    choices: ["See Picture"]},

    {type: jsPsychImageButtonResponse,
      stimulus: 'image/unrelated1.jpg',
      trial_duration: 10000,
      stimulus_height: 800,
      stimulus_width: 600,
      on_finish: function(data){
        data.stim_id = 'unrelated1.jpg'},
      choices: ["I'm Ready"]
    },
    
  // simulate a countdown for recording to start
  {type: jsPsychHtmlKeyboardResponse,
    stimulus: 'Begin speaking your answer in 3...',
    choices: 'NO_KEYS',
    on_finish: function(data){
        data.stim_id = 'unrelated1.jpg'},
    trial_duration: 1050
  },
  
  // simulate a countdown for recording to start
  {type: jsPsychHtmlKeyboardResponse,
    stimulus: 'Begin speaking your answer in 2...',
    choices: 'NO_KEYS',
    on_finish: function(data){
        data.stim_id = 'unrelated1.jpg'},
    trial_duration: 1050
  },
  
  // simulate a countdown for recording to start
  {type: jsPsychHtmlKeyboardResponse,
    stimulus: 'Begin speaking your answer in 1...',
    choices: 'NO_KEYS',
    on_finish: function(data){
      data.stim_id = 'unrelated1.jpg'},
    trial_duration: 1050
  },

  {
    type: jsPsychHtmlAudioResponse,
    stimulus: 'RECORDING...',
    recording_duration: 5000,
    show_done_button: true,
    done_button_label: "Finish Recording",
    // save audio
    on_finish: function(data){
      data.stim_id = 'unrelated1.jpg';
      //subject name
      purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
      // audio file name
      jsPsych.data.get().last(5).values()[0].stimulus.substring(6), 
      // current js data object
      data),
    console.log(jsPsych.data.get().last(5).values()[0].stimulus.substring(6))
}}
  ]
}

timeline.push(SC4_trials)




/***** COMMUNICATIVE ADEQUACY BLOCK *********
These questions involve participants listening and responding to a sustained simulated conversation. They will listen to the recording and then be asked to record their response. They will only be able to listen to each turn once. 

- do we need a practice session? or at least one practice item to start? 

*/

// record answer trial for CA trials
const record_answer_CA = {
    type: jsPsychHtmlAudioResponse,
    stimulus: 'RECORDING...',
    recording_duration: 5000,
    show_done_button: true,
    done_button_label: "Finish Recording",
    // save audio
    on_finish: function(data){
        //subject name
      purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
      // audio file name
      jsPsych.data.get().last(3).values()[0].stimulus.substring(6), 
      // current js data object
      data)
}}

var ca_stim = [
    {turn1: 'audio/fiona1.mp3', 
    turn2: 'audio/fiona2.mp3', 
    turn3: 'audio/fiona3.mp3', 
    data: {stim_id: 'fiona'}},
    
    {turn1: 'audio/torin1.mp3', 
    turn2: 'audio/torin2.mp3', 
    turn3: 'audio/torin3.mp3', 
    data: {stim_id: 'torin'}}
];

// instructions for communicative adequacy
const prepare_trials = {
  type: jsPsychInstructions,
  pages: ['This test requires you to participate in some short back-and-forth conversations',
  'You will first hear a speaker say something, and then you will record your response.',
  'You will then hear the speaker reply, and you will then record your response.', 
  'The test will start recording you as soon as you click the "record response" button.', 
  'You will only hear the audio once.'],
  choices: ['LET\'S GO!'],
  on_finish: function(){console.log(ca_stim)}
}

//timeline.push(prepare_trials)

// communicative adequacy timeline. 
// define repeated trials. 

// this might need to be changed so that each label is different for the 1st, 2nd, and 3rd playing. 
const play_audio_button = {
    type: jsPsychHtmlButtonResponse,
    stimulus: '',
    choices: ['PLAY AUDIO']
};

const conversations = {
  timeline: [
  {type: jsPsychHtmlButtonResponse,
  stimulus: 'You are about to begin a NEW conversation.',
  choices: ['BEGIN']},

  play_audio_button,

  {type: jsPsychAudioKeyboardResponse,
  stimulus: jsPsych.timelineVariable('turn1'),
  data: jsPsych.timelineVariable("data"),
  choices: 'NO_KEYS',
  trial_ends_after_audio: true},
    
  record_response_button,

  record_answer_CA,
    
  play_audio_button,

  {type: jsPsychAudioKeyboardResponse,
  stimulus: jsPsych.timelineVariable('turn2'),
  data: jsPsych.timelineVariable("data"),
  choices: 'NO_KEYS',
  trial_ends_after_audio: true},

  record_response_button,

  record_answer_CA,

  play_audio_button,

  {type: jsPsychAudioKeyboardResponse,
  stimulus: jsPsych.timelineVariable('turn3'),
  data: jsPsych.timelineVariable("data"),
  choices: 'NO_KEYS',
  trial_ends_after_audio: true},
    
  record_response_button,

  record_answer_CA,

  {type: jsPsychHtmlKeyboardResponse,
  stimulus: "LOADING NEXT ITEM...",
  trial_duration: 2500,
  choices: "NO_KEYS"
  }
  
 ], timeline_variables: baf_stim}

//timeline.push(conversations)


/***** LISTENING COMPREHENSION BLOCK *********
Participants will listen to a audio dialogues in French. After the dialogues they will answer different questions:
1. Listen to a dialogue and indicate which pictures each line of the dialogue corresponds to (how to do this???) 
2. Choosing from two pictures: one picture represents information from the dialogue, and one does not. 
3. Listen to a short dialogue (twice), and then respond to written comprehension questions orally using French. There is a 30-sec
*/


/**** LC1 - Two Dialogues*******
Listen to two dialogues and choose which picture from among four pictures matches the dialogue
Each trial shows pictures, plays dialogue once, then immediately plays again, then participants make choice. 
*/

// stim for timeline variable
var LC1_timeline_stimuli = [
  {dialogue: 'audio/fiona1.mp3', data:{stim_id: 'dialogue1'}},
  {dialogue: 'audio/fiona2.mp3', data:{stim_id: 'dialogue1'}}
]

// stim for media preloading
var LC1_images = ['image/LC1_A.png','image/LC1_B.png','image/LC1_C.png','image/LC1_D.png']
var LC2_audio = ['audio/fiona.mp3']

// preload LC1 stimuli just before the trial. 
var LC1_preload = {
  type: jsPsychPreload,
  images:LC1_images,
  audio: LC2_audio
}

//timeline.push(LC1_preload)

var LC1_instructions = {
  type: jsPsychInstructions,
  pages: ['For this question you will hear <b>two</b> different dialogues, two times each.',
  'While listening to the dialogue, you will also be shown four images.',
  'Your task is to select which image corresponds to each dialogue.',
  'One image corresponds to the first dialogue, and another image corresponds to the second dialogue.',
  'Two images do not correspond to either dialogue.',
  'After listening to the dialogue, indicate you answer by clicking the corresponding button.'],
show_clickable_nav: true,
}

//timeline.push(LC1_instructions)


var LC1_trials = {
  timeline: [

  // defined above. 
  play_audio_button,

  // this trial type is the best way to get image responses to audio. 
  // images load slightly slower than the audio, so audio needs a time buffer. 
  {type: jsPsychAudioButtonResponse,
  data: jsPsych.timelineVariable("data"),
  prompt: 'Which image best matches the dialogue?<br><img src = "image/LC1_A.png"><img src = "image/LC1_B.png"><img src = "image/LC1_C.png"><img src = "image/LC1_D.png">',
  stimulus: jsPsych.timelineVariable('dialogue'),
  //prompt: "Which image corresponds to the dialogue you just heard?",
  response_allowed_while_playing: false,
  choices: ['Image A', 'Image B', 'Image C', 'Image D']},
  
 
], timeline_variables: LC1_timeline_stimuli}

//timeline.push(LC1_trials)


/***** LC2 - messages *******
 * Participants will see two pictures. They will hear a short message play twice. They will then choose which picture matches the message.
*/

// LC2 timeline stimuli
var LC2_timeline_stimuli = [
  {message: 'audio/fiona1.mp3', image: 'image/m1_img.jpg', data:{stim_id: 'message1'}},
  {message: 'audio/torin1.mp3', image: 'image/m2_img.jpg', data:{stim_id: 'message2'}}
]

//LC2 lists for preload
var LC2_images = ['image/m1_img.jpg', 'image/m2_img.jpg']
var LC2_audio = ['audio/fiona1.mp3', 'audio/torin1.mp3']


// LC2 preload media
var LC2_preload = {
  type: jsPsychPreload,
  images: LC2_images,
  audio: LC2_audio
}

//timeline.push(LC2_preload)

var LC2_instructions = {
  type: jsPsychInstructions,
  pages: ['For this question you will hear a short message from a person.',
  'You will also be shown two images.',
  'Your task is to select which image corresponds to the speaker of the message.',
  'You will listen to the message twice before making your answer.',
  'Indicate you answer by clicking on the corresponding button.'],
show_clickable_nav: true,
}
//timeline.push(LC2_instructions)


var LC2_trials = {
  timeline: [

  // defined above
  play_audio_button,

  {type: jsPsychAudioButtonResponse,
  on_start: function(trial){
    trial.prompt = "Which image corresponds to the message?<br><img src = ".concat(jsPsych.timelineVariable('image')).concat(">")},
  data: jsPsych.timelineVariable("data"),
  stimulus: jsPsych.timelineVariable('message'),
  response_allowed_while_playing: false,
  choices: ['Image A', 'Image B']},

  {type: jsPsychHtmlButtonResponse,
    stimulus: 'Press continue to proceed to the next question',
  choices: ["Continue"]}
], timeline_variables: LC2_timeline_stimuli
}

//timeline.push(LC2_trials)


/*LC3 - audio answers ******
* participant will hear a short monologue. It will play once, pause for 30 seconds, then play again.
* participant will also see four questions
* after the second dialogue, participants will respond orally to the four questions. 
* participants will have a maximum of 2 minutes to record their answers. 
* TWO trials like this per test
*/

// record answer trial for story completion trials
const record_answer_LC = {
    type: jsPsychHtmlAudioResponse,
    on_start: function(trial){
      trial.stimulus = 'RECORDING...<br><br><br>'.concat(jsPsych.timelineVariable('questions'))
    },
    stimulus: '',
    recording_duration: 5000,
    show_done_button: true,
    done_button_label: "Finish Recording",
    // save audio
    on_finish: function(data){
        //subject name
      purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
      // audio file name
      jsPsych.data.get().last(5).values()[0].stimulus.substring(6), 
      // current js data object
      data),
      console.log(jsPsych.data.get().last(5).values()[0].stimulus.substring(6))
}}

// LC3 stimuli for timeline
var LC3_timeline_stimuli = [{monologue: 'audio/fiona1.mp3', questions: '<ul><li>Question 1</li><li>Question2</li><li>Question3</li><li>Question 4</li></ul>', data: {stim_id: 'monologue1'}},
{monologue: 'audio/torin1.mp3', questions: '<ul><li>Question 1</li><li>Question2</li><li>Question3</li><li>Question 4</li></ul>', data: {stim_id: 'monologue1'}}]

var LC3_audio = ['audio/fiona1.mp3', 'audio/torin1.mp3']

var LC3_preload = {
  type: jsPsychPreload,
  audio: LC3_audio
}
timeline.push(LC3_preload)

var LC3_instructions = {
  type: jsPsychInstructions,
  pages: ['In the next questions you will hear a speaker talk about an event',
  'You will also see four questions (in French) about the event',
  'You will listen to the audio twice, with a 30 second break between the audio',
  'After you hear the audio for the second time, you will answer the questions by speaking in French.',
  'Please try to answer all four questions in your response. You will have up to two minutes to answer the four questions.'],
show_clickable_nav: true,
}
//timeline.push(LC3_instructions)

var LC3_trials = {
  timeline: [

  // defined above
  play_audio_button,

  {type: jsPsychAudioKeyboardResponse, 
  prompt: jsPsych.timelineVariable('questions'),
  data: jsPsych.timelineVariable("data"),
  stimulus: jsPsych.timelineVariable('monologue'),
  trial_ends_after_audio: true,
  choices: "NO_KEYS"},
  
  // simulate a countdown for recording to start
  {type: jsPsychHtmlKeyboardResponse,
    stimulus: 'Begin speaking your answer in 3...',
    choices: 'NO_KEYS',
    trial_duration: 1050
  },
  
  // simulate a countdown for recording to start
  {type: jsPsychHtmlKeyboardResponse,
    stimulus: 'Begin speaking your answer in 2...',
    choices: 'NO_KEYS',
    trial_duration: 1050
  },
  
  // simulate a countdown for recording to start
  {type: jsPsychHtmlKeyboardResponse,
    stimulus: 'Begin speaking your answer in 1...',
    choices: 'NO_KEYS',
    trial_duration: 1050
  },
 
  // participant records response
  record_answer_LC,

  {type: jsPsychHtmlButtonResponse,
    stimulus: 'Press continue to proceed to the next question',
  choices: ["Continue"]}
], timeline_variables: LC3_timeline_stimuli
}
//timeline.push(LC3_trials)

/*LC4 - multiple guess questions ******
* participant will hear a short monologue. It will play once, pause for 30 seconds, then play again.
* participants will then answer multiple choice questions which include both text and images. 
* questions are shown while listening to the audio
*/

// LC4 stimuli for timeline
var LC4_timeline_stimuli = [
  {phone_audio: 'audio/fiona1.mp3', survey_questions: [
  {prompt: 'What is his birthday?', name: 'phone1Q1', options: ['A', 'B', 'C', 'D'], required: true, horizontal: true}, 
  {prompt: 'Which picture?', name: 'phone1Q2', options: ['<img src = image/LC4_A.png height = 200, width = 250>', '<img src = image/LC4_B.png height = 200, width = 250>'], required: true, horizontal: true},
  {prompt: 'Who will take the cake?', name: 'phone3Q3', options: ['Cat', 'Zebra', 'Kiwi'], required: true, horizontal: true}],
  question_display: 'What is his birthday? <br><br> Which picture? <br><br> Who will take the cake?', 
            data: {stim_id: 'phone1'}},

{phone_audio: 'audio/torin1.mp3', 
survey_questions: [
  {prompt: 'What is his birthday?', name: 'phone2Q1', options: ['A', 'B', 'C', 'D'], required: true, horizontal: true}, 
  {prompt: 'Which picture?', name: 'phone2Q2', options: ['<img src = image/LC4_B.png height = 200, width = 250>', '<img src = image/LC4_A.png height = 200, width = 250>'], required: true, horizontal: true},
  {prompt: 'Who will take the cake?', name: 'phone3Q3', options: ['Cat', 'Zebra', 'Kiwi'], required: true, horizontal: true}], 
  // to see questions during audio
  question_display: 'What is his birthday? <br><br> Which picture? <br><br> Who will take the cake?', 
data: {stim_id: 'phone2'}}
        
]

//var LC4_timeline_stimuli = [{phone_audio: 'audio/fiona1.mp3', question_strings:[], question_buttons: [], 
  //          data: {stim_id: 'phone1'}}]

var LC4_audio = ['audio/fiona1.mp3', 'audio/torin1.mp3']
var LC4_images = ['image/LC4_A.png', 'image/LC4_B.png']

var LC4_preload = {
  type: jsPsychPreload,
  audio: LC4_audio,
  images: LC4_images
}
timeline.push(LC4_preload)

var LC4_instructions = {
  type: jsPsychInstructions,
  pages: ['For these next questions you will listen to a short phone message from a speaker.',
  'You will also see several multiple choice questions asking about the message.',
  'You will listen to the audio twice, with a 30 second break between the audio.',
  'After you hear the audio for the second time, please indicate your answers to the questions.'],
show_clickable_nav: true,
}
timeline.push(LC4_instructions)

var LC4_trials = {
  timeline: [
  
  // listen to audio while seeing questions
  {type: jsPsychAudioKeyboardResponse, 
  prompt: jsPsych.timelineVariable('question_display'),
  data: jsPsych.timelineVariable("data"),
  stimulus: jsPsych.timelineVariable('phone_audio'),
  trial_ends_after_audio: true,
  choices: "NO_KEYS"},


  {type: jsPsychSurveyMultiChoice,
  questions: jsPsych.timelineVariable('survey_questions')}

  ], timeline_variables: LC4_timeline_stimuli
}

timeline.push(LC4_trials)





/***** C-TEST *********
Participants will read three short texts. Each text will have some words missing parts of the word. Participants must type in letters in order to provide correct words. 
*/

var french_characters = 'If your keyboard does not have French accents, please use these numbers to replace the appropriate letter with the corresponding number:<br> 1 = &agrave; <br>2 = &eacute; <br>3 = &ecirc; <br>4 = &egrave;<br>Example: For the word <b>&eacute;cole</b>, please type it as <b>2cole</b><br><br>'

var c_test_stim = [
    {c_text: french_characters.concat("Coucou, tu es d'accord pour m'aider &agrave; organiser l'anniversaire de Clara? Hier, no%% avons pr&eacute;%% un gr%% g&acirc;teau a%% chocolat. M%% s&oelig;urs o%% achet&eacute; d%% d&eacute;corations e%% des bon%% hier mi%%. Tu pe%% prendre d%% boissons e%% de l%% glace. L%% f&ecirc;te e%% samedi, ch%% moi.  Vi%% av%% ton co%% de fran%%, on v%% faire u%% salade d%% fruits ense%%.  Apr&egrave;s o%% va pr&eacute;p%% la mai%% et met%% de l%% musique. Appelle-moi quand tu arrives."), data: {stim_id: 'ctest_text1'}}
]

var c_test_instructions = {
  type: jsPsychInstructions,
  pages:['In this part of the test you will see a text presented on the screen.',
'In the following texts, parts of some words is missing.', 
'Please write in the missing letters to complete the words.',
'You will have 5 minutes for each text.',
'Please click Continue to see the first text.'],
show_clickable_nav: true
}

//timeline.push(c_test_instructions);
//https://github.com/jspsych/jsPsych/discussions/2543


var c_test_trials = {
timeline:[
{type: jsPsychHtmlButtonResponse,
stimulus: 'Press "Continue" to see the text.',
choices: ['Continue'],
},

{type: jsPsychCloze,
text: jsPsych.timelineVariable('c_text'),
data: jsPsych.timelineVariable("data"),
trial_duration: 300000,
},

{type: jsPsychHtmlKeyboardResponse,
stimulus: 'next',
choices: [' ']}
], timeline_variables: c_test_stim
}

//timeline.push(c_test_trials);



 var end = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: 'Press the spacebar to end the test',
  choices: ' '
 }
 
 timeline.push(end)
 

jsPsych.run(timeline);
</script>