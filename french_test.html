<!DOCTYPE html>
<html>
  <head>
  <title>French Test</title>
  <script type = "text/javascript" src="jquery-3.6.0.js"></script>
  <script id = "helper"></script>
  <script>
    // force reload of stimuli pages (for development.)
    var stable = "helper_functions.js?="
    var dynamic = Date.now()
    var parent = document.getElementById("helper")
    var someScriptElement = document.createElement("script")
    someScriptElement.setAttribute("src", stable + dynamic)
    helper.appendChild(someScriptElement)
    </script>
  <script src = "jspsych/jspsych.js"></script>
  <script src = 'jspsych/plugin-fullscreen.js'></script>
  <script src = "jspsych/plugin-html-keyboard-response.js"></script>
  <script src = "jspsych/plugin-initialize-microphone.js"></script>
  <script src = "jspsych/plugin-html-audio-response.js"></script>
  <script src = "jspsych/plugin-audio-keyboard-response.js"></script>
  <script src = "jspsych/plugin-audio-button-response.js"></script>
  <script src = "jspsych/plugin-html-button-response.js"></script>
  <script src = "jspsych/plugin-image-button-response.js"></script>
  <script src = "jspsych/plugin-image-keyboard-response.js"></script>
  <script src = "jspsych/plugin-survey-multi-select1.js"></script>
  <script src = "jspsych/plugin-survey-multi-choice1.js"></script>
  <script src = "jspsych/plugin-survey-html-form.js"></script>
  <script src = "jspsych/plugin-survey-html-form-timeout5.js"></script>
  <script src = "jspsych/plugin-instructions.js"></script>
  <script src = "jspsych/plugin-cloze19.js"></script>
  <script src = "jspsych/plugin-survey-text.js"></script>
  <script src="jspsych/plugin-preload.js"></script>
  <link href = "jspsych/jspsych.css" rel="stylesheet" type = "text/css" />
  <script src = 'stimuli.js' type = 'text/javascript'></script>   
  </head>
  <body></body>  
  <script>
  const jsPsych = initJsPsych({
    on_finish: function(data){
      jsPsych.data.displayData();
     // console.log('finished')
      // save data to csv
      saveData(jsPsych.data.get().select('subject').values[0].Q0, jsPsych.data.get().csv())
     // window.location = "https://www.duolingo.com";
    }
  });
  </script>
</html>

<script>
/*version A
- need to create separate data folders for versions A and B, or otherwise figure out how to sort this properly.
*/
const test_version = 'A'
const timeline = []



/* reuse this countdown variable throughout*/
const countdown321 =  
{
  // simulate a countdown for recording to start
  type: jsPsychHtmlKeyboardResponse,
  choices: 'NO_KEYS',
  trial_duration: 1050,
  timeline: [
    {stimulus: 'Begin recording in 3...'},
    {stimulus: 'Begin recording in 2...'},
    {stimulus: 'Begin recording in 1...'}
  ]}



const five_minute_break1 = 
{
  type: jsPsychHtmlButtonResponse, 
  stimulus: 'Nice work - you have completed 1 of 6 tasks!<br><br>Before moving on to the next section of the test, please take a short break (not longer than five minutes).<br><br> Press "Continue" when you are ready to move to the next part of the test.<br><br>',
  choices:  ["Continue"]
  }

const five_minute_break2 = 
{
  type: jsPsychHtmlButtonResponse, 
  stimulus: 'Nice work - you have completed 2 of 6 tasks!<br><br>Before moving on to the next section of the test, please take a short break (not longer than five minutes).<br><br> Press "Continue" when you are ready to move to the next part of the test.<br><br>',
  choices:  ["Continue"]
  }

const five_minute_break3 = 
{
  type: jsPsychHtmlButtonResponse, 
  stimulus: 'Nice work - you have completed 3 of 6 tasks!<br><br>Before moving on to the next section of the test, please take a short break (not longer than five minutes).<br><br> Press "Continue" when you are ready to move to the next part of the test.<br><br>',
  choices:  ["Continue"]
  }

const five_minute_break4 = 
{
  type: jsPsychHtmlButtonResponse, 
  stimulus: 'Nice work - you have completed 4 of 6 tasks!<br><br>Before moving on to the next section of the test, please take a short break (not longer than five minutes).<br><br> Press "Continue" when you are ready to move to the next part of the test.<br><br>',
  choices:  ["Continue"]
  }

const five_minute_break5 = 
{
  type: jsPsychHtmlButtonResponse, 
  stimulus: 'Nice work - you have completed 5 of 6 tasks - only one more to go!<br><br>Before moving on to the next section of the test, please take a short break (not longer than five minutes).<br><br> Press "Continue" when you are ready to move to the next part of the test.<br><br>',
  choices:  ["Continue"]
  }


const no_cheating = 
{
  type: jsPsychHtmlButtonResponse,
  stimulus: 'As a reminder, please do not use any dictionaries, translation tools, or other language aids. We are only interested in <b>your</b> knowledge of French.<br><br>',
  choices: ["I Understand"]
}

// function to create countdown timers. 
// requires a span with id = clock to modify the inner HTML of the question.
// must be associated with a htmlButtonResponse jsPsych trial item
function countdown_timer(duration){
  var wait_time = duration; // total time to wait
  var start_time = performance.now(); // get current time
  
  var interval = setInterval(function(){  
      // calculate time left and convert to minutes/seconds
      var time_left = wait_time - (performance.now() - start_time);
      var minutes = Math.floor(time_left / 1000 / 60);
      var seconds = Math.floor((time_left - minutes * 1000 * 60)/1000);
      var seconds_str = seconds.toString().padStart(2,'0');
      
      // populate the clock html with the minutes and seconds
      document.querySelector('#clock').innerHTML = minutes + ':' + seconds_str
        
      // we need to stop the timer if subject clicks button
      // listen for the button being clicked to end the trial early.
      var clicked = false
      
      // kill the interval if button clicked
      const btn = document.querySelector('button')
      btn.addEventListener("click", () => {
      //clicked = true
      clearInterval(interval);
      });
        
      // if the timer runs out, clear interval and replace with a message
      if(time_left <= 0){
        clearInterval(interval)
        document.querySelector('#clock').innerHTML = "Time's Up!"
      }
    
    }, 250)}


// will be changed to get from URL variable, and also concat it to the test version. 
var get_subject = {
  type: jsPsychSurveyText,
  questions: [{prompt: 'Please enter subject id'}],
  on_finish: function(data){
    jsPsych.data.addProperties({subject: data.response})
    console.log(jsPsych.data.get().select('subject').values[0].Q0)
  }
}

var refresh_warning = {
    type: jsPsychHtmlButtonResponse,
    stimulus: '<p style = "font-size: 30px; color: red"><b>WARNING</b></p><p>You should set aside at least one hour to complete this test. This test should be completed in one go - you cannot save your data and return later.<br><br>During the test, please <b>do not</b> refresh your browser or use the back button. <br>Doing so will result in a loss of all your data, and will be unable to continue with this project.<br><br>Finally, please do not use any dictionaries, translation tools, or other language aids. We are only interested in <b>your</b> knowledge of French.',
    choices: ['I Understand']
};


/* activate microphone and ensure participants can hear themselves being recorded.*/

// explain microphone connection
const prepare_microphone = {
    type: jsPsychHtmlButtonResponse,
    stimulus: '<p style = "font-size: 30px; color: red"><b>Prepare Microphone</b></p><p>Please connect your microphone to the computer.<br>We recommend using a pair of headphones with a microphone.<br><br>Once you have connected your microphone & headphones to the computer, click this button to prompt browser access to your microphone.<br>',
    choices: ['Add Microphone'],
}

// prompt for permission and initialise microphone
const ready_microphone = {
    type: jsPsychInitializeMicrophone
}

// explain to participants they need to make sure they can hear themselves. 
const test_audio_instructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: 'Let\'s make sure the test can hear you.<br>Please click the button below and speak into your microphone for a few seconds.<br>Afterwards, you will be able to play your recording.<br><br>Please make sure that you can hear your recording. If not, please make sure you microphone is working properly and try again. <br> Please do not continue the test until you are able to hear a recording of yourself played back to you.<br><br>',
  choices: ['Begin Recording']
}

// allow recording and playback, recording limited to 10 seconds. 
const test_audio = {
  type: jsPsychHtmlAudioResponse,
    recording_duration: 10000,
    stimulus: 'RECORDING...',
    allow_playback: true,
    show_done_button: true,
    record_again_button_label: 'Record Again',
    on_finish: function(data){
      data.response = 'sanitized'}
}

// honor system - participants will click to move on. 
const recording_passed = {
    type: jsPsychHtmlButtonResponse,
    stimulus: 'Thank you. You have indicated that you are able to hear yourself in the recording.<br>Press Continue when you are ready to continue the test.',
    choices: ['Continue'],
}

var enter_fullscreen = {
  type: jsPsychFullscreen,
  fullscreen_mode: true
};

/*
Story Completion Part 1 - single image of a park
*/


// what to do with this? 
// var SC_task_instructions = {
//   type: jsPsychHtmlButtonResponse,
//   stimulus: '<p  style = "font-size: 30px"><b>Speaking Tasks</b><p class = "instructions">In this next part, you will complete three short speaking tasks.<p class = "instructions">For each task, you will see pictures. Your task is to describe or tell the story based on the pictures. You must use complete sentences. <br><br>But, since, since you\'re in the process of learning French, you can give a list of vocabulary words that you know to describe the picture. You can also use words in English to complete your ideas. But only if you don\'t know the French words! We look forward to hearing your stories!<p>Click "Continue" to move on to the first speaking task.',
//   choices: ["Continue"]
// }



var SC1_preload = {
  type: jsPsychPreload,
  images: 'image/PD_1.png',
  message: 'Loading...'
}


var SC1_instructions = {
type: jsPsychHtmlButtonResponse,
stimulus: '<p style = "font-size: 30px"><b>Picture description task</b><p class = "instructions"><b>Objective</b><br>Describe the people and the activities the people are doing.<br><br><b>Procedure</b><br>You will see an image with many people, doing many activities. You will have 30 seconds to study the image and then 3 minutes to describe what is happening in the image.<br><br> You can focus on: <ul style = "text-align: left"><li>Activities</li><li>People: clothing (color, types), physical traits, likes/dislikes</li><li>Objects (food, vehicles), and their location on the image</li><li>Weather</li></ul>',
choices: ['Continue']
}




var SC1_trials = {
  timeline: [
    {type: jsPsychHtmlButtonResponse,
    stimulus: 'Once you click this button, you will have 30 seconds to study the picture and prepare your response.<br>',
    choices: ["See Picture"]},

    {type: jsPsychImageButtonResponse,
      stimulus: 'image/PD_1.png',
      trial_duration: 31000, // should be 30 seconds (30000 ms), add 1000ms (1 second) as buffer
      
      prompt: '<br><span id = "clock" style = "color:red">-:--</span><br><p style = "text-align: left">Remember to describe:</p><ul style = "text-align: left; font-size: 12"><li>People: clothing (color, types), physical traits, likes/dislikes</li><li>Objects (food, vehicles), and their location on the image</li><li>Activities</li><li>Weather</li></ul>',
      
      // countdown timer
      on_load: function(){
        countdown_timer(31000)},

      on_finish: function(data){
        data.stim_id = 'PD_1'
      },
      choices: ["I'm Ready"]
    },

    // 3 second countdown
    countdown321,

  // record answer 

  {
    type: jsPsychHtmlAudioResponse,
    stimulus: '<img src = "image/PD_1.png"><br><p style = "color:red"><b>RECORDING</b></p><span id = "clock" style = "color:red">-:--</span><p style = "text-align: left"><p>Remember to describe:</p><ul style = "text-align: left; font-size: 12"><li>People: clothing (color, types), physical traits, likes/dislikes</li><li>Objects (food, vehicles), and their location on the image</li><li>Activities</li><li>Weather</li></ul></p>',
    
    recording_duration: 181000, // trial duration should be 3 minutes (180000ms), add 1000ms as a buffer
    show_done_button: true,
    done_button_label: "Finish Recording",
    
    // countdown timer
    on_load: function(){
      countdown_timer(181000)},
    
    on_finish: function(data){
        data.stim_id = 'PD_1';
      //subject name
      purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
      // audio file name
      jsPsych.data.get().last(5).values()[0].stimulus.substring(6), 
      // current js data object
      data),
      console.log(jsPsych.data.get().last(5).values()[0].stimulus.substring(6))
}
}
  ]
}


/* Story Completion Part 2 - six-panel images making a story
- 30 seconds to prepare
- 3 minutes for response
- size images to be w600xh800
- 1 trial so no need for timeline variables. 
*/


var SC2_preload = {
  type: jsPsychPreload,
  images: ['image/jules_storyboard.jpg', 
  'image/a_new_life_in_montreal_canada001.png', 
  'image/a_new_life_in_montreal_canada002.png',
  'image/a_new_life_in_montreal_canada003.png',
  'image/a_new_life_in_montreal_canada004.png',
  'image/a_new_life_in_montreal_canada005.png'],
  message: "Loading..."
}


var SC2_instructions = {
  type: jsPsychHtmlButtonResponse,
  on_start: function(trial){
    trial.stimulus = '<b style = "font-size: 30px">Picture Narration Task</b><p class = "instructions"><br><b>Objective</b><br>Tell the story with as many interesting details as you can.<br><br><b>Procedure</b><br>You will see five images about Jules\' new life in Montreal.<br><img src = image/jules1.png><br>Create an original story using the pictures as a source of inspiration. Give extra details based on your imagination to make the story more interesting. <b>For each image, try to create at least 4 unique sentences using French.</b> You will have 1 minute to plan your story and 3 minutes to tell your story. If you forget some words, you can use English.<br>'
  },
  stimulus: '',
  choices: ['Continue']
}


var SC2_trials = {
  timeline: [
    {
      type: jsPsychHtmlButtonResponse,
    stimulus: 'Once you click this button, you will have 1 minute to study the picture and prepare your response',
    choices: ["See Picture"]
  },

    {
      type: jsPsychImageButtonResponse,
      stimulus: 'image/jules_storyboard.jpg',
      prompt: '<b><span id = "clock" style = "color:red">-:--</span></b>',
      trial_duration: 61000, // should be 60 seconds (60,000 ms), add 1000 ms as buffer
     // countdown timers
     on_load: function(){
      countdown_timer(61000)},

      on_finish: function(data){
        data.stim_id = 'jules_storyboard'},
      choices: ["I'm Ready"]
    },

    // 3 second countdown
    countdown321,

    // record answer 
  {
    type: jsPsychHtmlAudioResponse,
    stimulus: '<img src = "image/a_new_life_in_montreal_canada001.png"><p style = "color:red"><b>RECORDING</b><br><span id = "clock" style = "color:red">-:--</span></p>',
    recording_duration: 41000, // make it 40 seconds per picture for now.
    show_done_button: true,
    done_button_label: "Finish Recording",
    // countdown timers
    on_load: function(){
      countdown_timer(41000)},
     
    //save audio
    on_finish: function(data){
        data.stim_id = 'jules1';
        //subject name
      purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
      // audio file name
      'a_new_life_in_montreal_canada001.png', 
      // current js data object
      data)},
},

{
  type: jsPsychHtmlKeyboardResponse,
  stimulus: '<b>Loading Next Image...</b>',
  trial_duration: 1500,
  choices: "NO_KEYS"
},

countdown321,

// record answer 
{
type: jsPsychHtmlAudioResponse,
stimulus: '<img src = "image/a_new_life_in_montreal_canada002.png"><p style = "color:red"><b>RECORDING</b><br><span id = "clock" style = "color:red">-:--</span></p>',
recording_duration: 41000, // make it 40 seconds per picture for now.
show_done_button: true,
done_button_label: "Finish Recording",
// countdown timers
on_load: function(){
  countdown_timer(41000)},
 
//save audio
on_finish: function(data){
    data.stim_id = 'jules2';
    //subject name
  purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
  // audio file name
  'a_new_life_in_montreal_canada002.png', 
  // current js data object
  data)},
},

{
type: jsPsychHtmlKeyboardResponse,
stimulus: '<b>Loading Next Image...</b>',
trial_duration: 1500,
choices: "NO_KEYS"
},

countdown321,

// record answer 
{
type: jsPsychHtmlAudioResponse,
stimulus: '<img src = "image/a_new_life_in_montreal_canada003.png"><p style = "color:red"><b>RECORDING</b><br><span id = "clock" style = "color:red">-:--</span></p>',
recording_duration: 41000, // make it 40 seconds per picture for now.
show_done_button: true,
done_button_label: "Finish Recording",
// countdown timers
on_load: function(){
  countdown_timer(41000)},

//save audio
on_finish: function(data){
    data.stim_id = 'jules3';
    //subject name
  purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
  // audio file name
  'a_new_life_in_montreal_canada003.png', 
  // current js data object
  data)},
},

{
type: jsPsychHtmlKeyboardResponse,
stimulus: '<b>Loading Next Image...</b>',
trial_duration: 1500,
choices: "NO_KEYS"
},

countdown321,

// record answer 
{
type: jsPsychHtmlAudioResponse,
stimulus: '<img src = "image/a_new_life_in_montreal_canada004.png"><p style = "color:red"><b>RECORDING</b><br><span id = "clock" style = "color:red">-:--</span></p>',
recording_duration: 41000, // make it 40 seconds per picture for now.
show_done_button: true,
done_button_label: "Finish Recording",
// countdown timers
on_load: function(){
  countdown_timer(41000)},

  //save audio
on_finish: function(data){
    data.stim_id = 'jules4';
    //subject name
  purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
  // audio file name
  'a_new_life_in_montreal_canada004.png', 
  // current js data object
  data)},
},

{
type: jsPsychHtmlKeyboardResponse,
stimulus: '<b>Loading Next Image...</b>',
trial_duration: 1500,
choices: "NO_KEYS"
},

countdown321,

// record answer 
{
type: jsPsychHtmlAudioResponse,
stimulus: '<img src = "image/a_new_life_in_montreal_canada005.png"><p style = "color:red"><b>RECORDING</b><br><span id = "clock" style = "color:red">-:--</span></p>',
recording_duration: 41000, // make it 40 seconds per picture for now.
show_done_button: true,
done_button_label: "Finish Recording",
// countdown timers
on_load: function(){
  countdown_timer(41000)},
  
//save audio
on_finish: function(data){
    data.stim_id = 'jules5';
    //subject name
  purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
  // audio file name
  'a_new_life_in_montreal_canada005.png', 
  // current js data object
  data)},
},
  ]
}


/* Story Completion Part 3 - story of Samantha or Max: before, now, and after.
- 30 seconds to prepare
- 3 minutes to record
*/

var SC3_preload = {
  type: jsPsychPreload,
  images: 'image/samantha1.png',
  message: 'Loading...'
}

var SC3_instructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: ['<p style = "font-size: 30px"><b>Timeline Description Task</b></p><p class = "instructions"><b>Objective</b><br>Tell Samantha\'s Story!<br><br><b>Procedure</b><br> You will see one image. Your task is to tell us what you think happened to Samantha one hour ago, what is happening to Samantha right now, and what will happen next. You will have one minute to plan and three minutes to record your story.<br><br>You story <b>must</b> include: <ol style = "text-align: left"><li>what happened one hour ago</li><li>what is happening now</li><li>what will happen next</li></ol>'],
  choices: ['Continue']
}


var SC3_trials = {
  timeline: [
    {type: jsPsychHtmlButtonResponse,
    stimulus: 'Once you click this button, you will have 30 seconds to study the picture and prepare your response.',
    choices: ["See Picture"]},

    {type: jsPsychImageButtonResponse,
      stimulus: 'image/samantha1.png',
      trial_duration: 31000, // should be 30 seconds (30,000 ms), add 1000 ms as buffer
      stimulus_height: 600,
      stimulus_width: 800,
      prompt: '<span id = "clock" style = "color:red">-:--</span>',
      choices: ["I'm Ready"],
      on_load: function(){
        countdown_timer('31000')
      },
      on_finish: function(data){
        data.stim_id = 'samantha_prepare'
      }
    },
    // 3 second countdown
    countdown321,
  {
    type: jsPsychHtmlAudioResponse,
    stimulus: '<img src = "image/samantha1.png" width = "800" height = "600"><p style = "color:red"><b>RECORDING</b><br><span id = "clock" style = "color:red">-:--</span></p>',
    recording_duration: 181000, // trial duration should be 3 minutes (180000ms), add 1000ms as a buffer
    show_done_button: true,
    done_button_label: "Finish Recording",
    // countdown timers
    on_load: function(){
      countdown_timer(181000)},
    
      // save audio
    on_finish: function(data){
      data.stim_id = 'samantha_record';
      //subject name
      purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
      // audio file name
      jsPsych.data.get().last(5).values()[0].stimulus.substring(6), 
      // current js data object
      data),
    console.log(jsPsych.data.get().last(5).values()[0].stimulus.substring(6))
}}
  ]
}


/***** COMMUNICATIVE ADEQUACY BLOCK *********
These questions involve participants listening and responding to a sustained simulated conversation. They will listen to the recording and then be asked to record their response. They will only be able to replay to each turn once. 
*/


var CA_timeline_stimuli = [
 
/* 
Define all the scenarios
*/

{scenario_num: 'DCT1', scenario: 'You are sick and calling the health clinic to <b>make an appointment</b> with your doctor.<br>The new receptionist is very busy learning her new tasks.<br><br>Start the conversation by:<br>1. Greeting the receptionist.<br>2. Requesting an appointment for tomorrow.<br><br>', reminder: 'Reminder: You are sick and calling the health clinic to <b>make an appointment</b> with your doctor.<br>The new receptionist is very busy learning her new tasks.', turn1: 'audio/1_infirmiere_1_trim.mp3', turn2: 'audio/1_infirmiere_2_trim.mp3', turn3: 'audio/1_infirmiere_3_trim.mp3', data: {stim_id: 'DCT1'}},

  {scenario_num: 'DCT2',scenario: 'You need a ride to school for your exam. The exam is Tuesday at 9h.<br>You call your friend to <b>ask for a ride</b>. Your friend is very tired because he started a new job.<br><br> Start the conversation by:<br>1. Greeting your friend.<br>2. Requesting a ride for Tuesday at 9h.<br><br>', reminder: 'Reminder: You need a ride to school for your exam. The exam is Tuesday at 9h.<br>You call your friend to <b>ask for a ride</b>. Your friend is very tired because he started a new job.', turn1: 'audio/2_auto_1_trim.mp3', turn2: 'audio/2_auto_2_trim.mp3', turn3: 'audio/2_auto_3_trim.mp3', data: {stim_id: 'DCT2'}},

  {scenario_num: 'DCT3',scenario: 'You are taking a French class and you need to practice outside of class for your upcoming exam.<br>You call Madame Janine, a retired French teacher, <b>to ask if you can be her student</b>.<br>Madame Janine has a good reputation and has many students.<br><br>Start the conversation by:<br>1. Greeting Madame Janine.<br>2. Requesting an appointment for a first course.<br><br>', reminder: 'Reminder: You are taking a French class and you need to practice outside of class for your upcoming exam.<br>You call Madame Janine, a retired French teacher, <b>to ask if you can be her student</b>.<br>Madame Janine has a good reputation and has many students. ', turn1: 'audio/3_cours_1_trim.mp3', turn2: 'audio/3_cours_2_trim.mp3', turn3: 'audio/3_cours_3_trim.mp3', data:{stim_id: 'DCT3'}},

  {scenario_num: 'DCT4',scenario: 'Your brother\'s graduation is coming up next weekend. The cake company canceled your order.<br>You <b>ask your best friend to make a cake</b> for the party, but she is sick.<br><br>Start the conversation by:<br>1. Greeting your friend.<br>2. Requesting a cake.<br><br>', reminder: 'Reminder: Your brother\'s graduation is coming up next weekend. The cake company canceled your order.<br>You <b>ask your best friend to make a cake</b> for the party, but she is sick.', turn1: 'audio/4_gateau_1_trim.mp3', turn2: 'audio/4_gateau_2_trim.mp3', turn3: 'audio/4_gateau_3_trim.mp3', data:{stim_id: 'DCT4'}},

  {scenario_num: 'DCT5',scenario: 'You arrive late to your mid-term French exam because you missed the bus.<br><b>You apologize to your professor</b>, Monsieur Jean, for being late.<br>You know how much your teacher hates it!<br><br>Start the conversation by:<br>1. Greeting your teacher Monsieur Jean.<br>2. Apologizing for being late and telling him that you will not arrive late again.<br><br>', reminder: 'Reminder: You arrive late to your mid-term French exam because you missed the bus.<br><b>You apologize to your professor</b>, Monsieur Jean, for being late.<br>You know how much your teacher hates it!', turn1: 'audio/5_retard_1_trim.mp3', turn2: 'audio/5_retard_2_trim.mp3', turn3: 'audio/5_retard_3_trim.mp3', data:{stim_id: 'DCT5'}},
];

// to be updated with new audio. 
var CA_audio = ['audio/1_infirmiere_1_trim.mp3', 'audio/1_infirmiere_2_trim.mp3', 'audio/1_infirmiere_3_trim.mp3', 'audio/2_auto_1_trim.mp3', 'audio/2_auto_2_trim.mp3', 'audio/2_auto_3_trim.mp3', 'audio/3_cours_1_trim.mp3', 'audio/3_cours_2_trim.mp3', 'audio/3_cours_3_trim.mp3', 'audio/4_gateau_1_trim.mp3', 'audio/4_gateau_2_trim.mp3', 'audio/4_gateau_3_trim.mp3', 'audio/5_retard_1_trim.mp3', 'audio/5_retard_2_trim.mp3', 'audio/5_retard_3_trim.mp3', 'audio/6_cle_1_trim.mp3', 'audio/6_cle_2_trim.mp3', 'audio/6_cle_3_trim.mp3']

// response duration max length for DCT (45 seconds + 1000 buffer)
const dct_response_time_max = 46000

// computer response inter trial interval
const computer_response_prompt = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: 'Their response is...',
  trial_duration: 1000
}

var CA_preload = 
{type: jsPsychPreload,
  audio: CA_audio,
  message: "Loading audio, please wait..."
}

const CA_instructions1 = {
  type: jsPsychHtmlButtonResponse,
  stimulus: '<p style = "font-size: 30px"><b>Conversation Task</b></p><p class = "instructions"><b>Objective</b><br>To have short, meaningful conversations with a computer simulation.<br><br><b>Procedure</b><br>Carefully read the scenario for each conversation, written in English. For each scenario, you will make four short recordings in French.',
  choices: ['Continue Instructions']
}


const CA_instructions2 = {
  type: jsPsychHtmlButtonResponse,
  stimulus: '<p class = "instructions">Based on the written scenario, you will begin the conversation. After your first recording, you will hear a computer-generated reply. You will have the option to replay the reply one time. You will then record a response to that reply. This back and forth will continue for two more responses for each conversation.<br><br> Please continue to see an example.',
  choices: ["Continue"]
}


const CA_example = {
  type: jsPsychHtmlButtonResponse,
  stimulus: '<p class = "instructions"><b>Example</b><br>Below is an example (in English) demonstrating how you should complete these conversations. Please take a moment to study the example. You will be hearing and recording your own answers <b>in French</b> for each conversation in the same format as this example.</p>' +

  '<p class = "instructions"><b>Scenario</b><br> You are working on a group project and one member did not finish her part. You call her to tell her that you are upset.</p>'

  +
    
    
    '<table><tr><th colspan = "2">Conversation Order</th><th colspan = "4">Example Conversation</th></tr>' +
    
    '<tr><td colspan = "2"><span style = "color:red">1. Start the conversation</span></td><td colspan = "3"><span style = "color:red">(Example of what you might say)</span><br>Hey Michelle. You did not send me your part and I had to do it. You were supposed to send it last night.</td></tr>' +
    
    '<tr><td colspan = "2">2. You will hear:</td><td colspan = "3">I\'m sorry. I got really sick, and couldn\'t finish it. What part should I do then?</td></tr>' +
    
    '<tr><td colspan = "2"><span style = "color:red">3. Record your reply</span></td><td colspan = "3"><span style = "color:red">(Example of what you might say)</span><br>Can you please do the conclusion?</td></tr>' + 
    
    '<tr><td colspan = "2">4. You will hear:</td><td colspan = "3">When should I send it?</td></tr>' +
    
    '<tr><td colspan = "2"><span style = "color:red">5. Record your reply</span></td><td colspan = "3"><span style = "color:red">(Example of what you might say)</span><br>You should send it to me by tomorrow.</td></tr>' +
    
    '<tr><td colspan = "2">6. You will hear:</td><td colspan = "3">Ok, will do!</td></tr>'
    +
    
    '<td colspan = "2"><span style = "color:red">Record your closing</span></td><td colspan = "3"><span style = "color:red">(Example of what you might say)</span><br>Great, thank you!</td></tr></table><br>',
  choices: ["I'm Ready"]
}


// communicative adequacy timeline. 
const CA_trials = {
  timeline: [
  {type: jsPsychHtmlButtonResponse,
  stimulus: 'You are about to begin a new conversation.<br><br>',
  choices: ['Begin Conversation']},

{
  type: jsPsychHtmlButtonResponse,
  stimulus: jsPsych.timelineVariable('scenario'),
  choices: ['Start your conversation...']
},

  // 3 second countdown
  countdown321,

  // record conversation opening
{
    type: jsPsychHtmlAudioResponse,
    on_start: function(trial){
      trial.stimulus = '<p style = "color:red"><b>RECORDING</b><br><span id = "clock" style = "color:red">-:--</span></p><br>'.concat(jsPsych.timelineVariable('reminder'))
    },
    stimulus: '',
    recording_duration: dct_response_time_max,
    show_done_button: true,
    data: jsPsych.timelineVariable("data"),
    done_button_label: "Finish Recording",
    // countdown timers
    on_load: function(){
      countdown_timer(dct_response_time_max)},

    // save audio
    on_finish: function(data){
        //subject name
      purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
      // audio file name
      jsPsych.timelineVariable('scenario_num').concat('_1_conversation_opening'),
      data)
}},

computer_response_prompt,

{
    timeline: [{
      type: jsPsychAudioButtonResponse,
      stimulus: jsPsych.timelineVariable('turn1'),
      choices: ['Play one more time', 'Continue'],
      response_allowed_while_playing: false,
      on_start: function(trial){
        if(jsPsych.data.getLastTrialData().values()[0].trial_type == 'html-keyboard-response'){
          trial.choices = ['Play one more time', 'Continue']
        } else {
          trial.choices = ['Continue']
        }
      }
    }], 

    loop_function: function(data){
      // check what previous trial was to determine if trial can be replayed
      if(data.values()[0].response == 0 && jsPsych.data.get().last(2).values()[0].trial_type == 'html-keyboard-response'){
          return true; // loop again!
      } else {
          return false; // continue
      }
    }
  },

  // 5 second countdown
  countdown321,

  // record answer to first turn.
{
    type: jsPsychHtmlAudioResponse,
    on_start: function(trial){
      trial.stimulus = '<p style = "color:red"><b>RECORDING</b><br><span id = "clock" style = "color:red">-:--</span></p><br>'
    },
    stimulus: '',
    recording_duration: dct_response_time_max, 
    show_done_button: true,
    data: jsPsych.timelineVariable("data"),
    done_button_label: "Finish Recording",
    on_load: function(){
      countdown_timer(dct_response_time_max)},

    // save audio
    on_finish: function(data){
        //subject name
      purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
      // audio file name
      jsPsych.timelineVariable('scenario_num').concat('_2_first_response'),
      // current js data object
      data)
}},
    
computer_response_prompt,

{
    timeline: [{
      type: jsPsychAudioButtonResponse,
      stimulus: jsPsych.timelineVariable('turn2'),
      choices: ['Play one more time', 'Continue'],
      response_allowed_while_playing: false,
      on_start: function(trial){
        if(jsPsych.data.getLastTrialData().values()[0].trial_type == 'html-keyboard-response'){
          trial.choices = ['Play one more time', 'Continue']
        } else {
          trial.choices = ['Continue']
        }
      }
    }],
    loop_function: function(data){
      // check what previous trial was to determine replays
      if(data.values()[0].response == 0 && jsPsych.data.get().last(2).values()[0].trial_type == 'html-keyboard-response'){
          return true; // loop again!
      } else {
          return false; // continue
      }
    }
  },

  // 5 second countdown
  countdown321,

   // record answer trial to second turn
   {
    type: jsPsychHtmlAudioResponse,
    on_start: function(trial){
      trial.stimulus = '<p style = "color:red"><b>RECORDING</b><br><span id = "clock" style = "color:red">-:--</span></p><br>'
    },
    stimulus: '',
    recording_duration: dct_response_time_max,
    show_done_button: true,
    data: jsPsych.timelineVariable("data"),
    done_button_label: "Finish Recording",
    on_load: function(){
      countdown_timer(dct_response_time_max)},

    // save audio
    on_finish: function(data){
        //subject name
      purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
      // audio file name
     jsPsych.timelineVariable('scenario_num').concat('_3_second_response'),
      // current js data object
      data)
}},

computer_response_prompt,

{
    timeline: [{
      type: jsPsychAudioButtonResponse,
      stimulus: jsPsych.timelineVariable('turn3'),
      choices: ['Listen one more time', 'Continue'],
      response_allowed_while_playing: false,
      on_start: function(trial){
        if(jsPsych.data.getLastTrialData().values()[0].trial_type == 'html-keyboard-response'){
          trial.choices = ['Play one more time', 'Continue']
        } else {
          trial.choices = ['Continue']
        }
      }
    }],
    loop_function: function(data){
      // check what previous trial was to determine replays
      if(data.values()[0].response == 0 && jsPsych.data.get().last(2).values()[0].trial_type == 'html-keyboard-response'){
          return true; // loop again!
      } else {
          return false; // continue
      }
    }
  },

  // 5 second countdown
  countdown321,

     // record answer to third turn
     {
    type: jsPsychHtmlAudioResponse,
    on_start: function(trial){
      trial.stimulus = '<p style = "color:red"><b>RECORDING</b><br><span id = "clock" style = "color:red">-:--</span></p><br>'
    },
    stimulus: '',
    recording_duration: dct_response_time_max,
    show_done_button: true,
    data: jsPsych.timelineVariable("data"),
    done_button_label: "Finish Recording",
    on_load: function(){
      countdown_timer(dct_response_time_max)},
    // save audio
    on_finish: function(data){
        //subject name
      purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
      // audio file name
      jsPsych.timelineVariable('scenario_num').concat('_4_conversation_ending'),
      // current js data object
      data)
}},

  {type: jsPsychHtmlKeyboardResponse,
  stimulus: "Loading next conversation...",
  trial_duration: 2500,
  choices: "NO_KEYS"
  }
 ], timeline_variables: CA_timeline_stimuli, randomize_order: true}


/***** C-TEST *********
Participants will read three short texts. Each text will have some words missing parts of the word. Participants must type in letters in order to provide correct words. 
*/

var french_keyboard = '<p style = "font-size:14px; text-align:center; border:dotted; width:500px;margin:auto">If your keyboard does not have French accents, please use these numbers to replace the appropriate letter with the corresponding number:<br>1 = &agrave;&emsp;&emsp;&emsp;2 = &eacute;&emsp;&emsp;&emsp;3 = &ecirc;&emsp;&emsp;&emsp;4 = &egrave;<br>Example: For the word <b>&eacute;cole</b>, please type it as <b>2cole</b><br><i>Please type in the missing letters to complete the words.</i></p><br><br><p style = "text-align:center"><span id = "clock" style = "color:red">-:--</span></p><br>'

var CT_stim = [
    {
    c_text: french_keyboard.concat('Bonjour, je m\'appelle Marise et j\'ai un animal de compagnie!<p>I%% est bl%%, brun, e%%, tr&egrave;s pe%%. Mon a%% a d%% belles orei%%.<p>El%% sont lon%%. <p>Le ma%%, je l%% donne d%% la nourr%%.<p>Il ma%% ses caro%% tr&egrave;s rapid%%! <p>Mon a%% sp&eacute;cial n\'a%% pas l%% chiens, ma%% il ad%% les enf%%.<p>Tu as devin&eacute;, mon ami c\'est un lapin.'), data: {stim_id: 'CTEST_1'}
},
{
    c_text: french_keyboard.concat("Coucou, tu es d\'accord pour m\'aider &agrave; organiser l\'anniversaire de Clara?<p>La f&ecirc;%% est sam%% chez m%%.<p>Nous av%% un exce%% g&acirc;teau a%% chocolat e%% mon fr%% a l%% d&eacute;corations <br>e%% la mu%%.<p>Viens av%% ton cop%%. On v%% pr&eacute;parer u%% grosse sal%% de fru%% ensemble.<p> Appelle-moi quand vous arrivez."), data: {stim_id: 'CTEST_2'}
},
{
    c_text: french_keyboard.concat("Un livre qui pr&eacute;tend introduire des aspects de la culture française ne serait pas complet sans un chapitre sur les beaux-arts.<p>En fa%%, de nomb%% touristes vo%% en Fra%% dans l\'inte%% d\'admirer s%% chefs-d\'&oelig;u%% de pein%%, d\'archit%% et d%% sculpture.<p>Q%% n\'a p%% entendu par%% du Louvre? d%% la cath%% Notre-Dame d%% Paris? des scul%% de Rodin?<p>Nous ne pouvons pas vous pr&eacute;senter une &eacute;tude en profondeur des beaux-arts en France."), data: {stim_id: 'CTEST_3'}
},

]

var CT_instructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: '<p style = "font-size: 30px"><b> Word Completion Task</b></p><p class = "instructions"><b>Objective</b><br>To fill in missing parts of a word to make texts complete.<br><br><b>Procedure</b><br> In the following texts, parts of some words are missing. Please type in the missing letters to complete the words. You will have 5 minutes for each text.<br><br>Do your best to not leave any spaces blank!',
choices: ['Continue']
}

// in case we want to REQUIRE answers 
// https://github.com/jspsych/jsPsych/discussions/2543


var CT_trials = {
timeline:[
{type: jsPsychHtmlButtonResponse,
stimulus: 'Press "Continue" to see the next text.',
choices: ['Continue'],
},

{
type: jsPsychCloze,
text: jsPsych.timelineVariable('c_text'),
data: jsPsych.timelineVariable("data"),
trial_duration: 301000,
button_text: '<br>Submit Answers</b>',
on_load: function(){
  countdown_timer(301000)
}
}
], timeline_variables: CT_stim, randomize_order: false
}


/***** ERROR CORRECTION TASK *********
Participants will see a sentence presented in text
They will know there is an error somewhere in the sentence
Their task is to locate and correct the error
*/

EC_timeline_stimuli = [
  {sentence: '<b>Dans mon bureau, je ai un ordinateur.</b>', 
  data: {stim_id: 'EC1'}
  },
  {sentence: '<b>Il parle pas espagnol avec ses amis.</b>', 
  data: {stim_id: 'EC2'}
  },
  {sentence: '<b>Il joue avec une balle dans le maison.</b>', 
  data: {stim_id: 'EC3'}
  },
  {sentence: '<b>Elisabeth veut une petit plante verte dans sa classe.</b>', 
  data: {stim_id: 'EC4'}
  },
  {sentence: '<b>Ta fr&egrave;re travaille toute la journ&eacute;e au magasin.</b>',
  data: {stim_id: 'EC5'}
  },
  {sentence: '<b>Ma s&oelig;ur a une fille et deux chien.</b>', 
  data: {stim_id: 'EC6'}
  },
  {sentence: '<b>Pour la salade, Julian pr&eacute;pare les tomates rouge.</b>', 
  data: {stim_id: 'EC7'}
  },
  {sentence: '<b>Le weekend, nous regardent la t&eacute;l&eacute;vision avec notre famille.</b>', 
  data: {stim_id: 'EC8'}
  },
  {sentence: '<b>Je m\'appeler Simon et je r&eacute;side au Canada.</b>', 
  data: {stim_id: 'EC9'}
  },
  {sentence: '<b>Cette ann&eacute;e, Madame Zuniga habites sur le campus.</b>', 
  data: {stim_id: 'EC10'}
  },
  {sentence: '<b>Pour c&eacute;l&eacute;brer ta f&ecirc;te, nous allent au restaurant.</b>', 
  data: {stim_id: 'EC11'}
  },
  {sentence: '<b>Tu fait du v&eacute;lo de montagne avec ta m&egrave;re.</b>', 
  data: {stim_id: 'EC12'}
  },
  {sentence: '<b>Elle a trouver un ballon de foot pour Judith.</b>', 
  data: {stim_id: 'EC13'}
  },
  {sentence: '<b>David et Laurence sont lou&eacute; une chambre d\'h&ocirc;tel.</b>', 
  data: {stim_id: 'EC14'}
  },
  {sentence: '<b>Nous achetons de le poisson au march&eacute;.</b>', 
  data: {stim_id: 'EC15'}
  },
  // what to do with blank line in number 16?
  {sentence: '<b>Je prends sucre avec mon caf&eacute;.</b>', 
  data: {stim_id: 'EC16'}
  },
  {sentence: '<b>Bonjour Madame Simard, tu aimes votre nouveau condo?</b>', 
  data: {stim_id: 'EC17'}
  },
  {sentence: '<b>Salut! C\'est moi, Julie. Voulez-vous aller au cin&eacute;ma demain?</b>', 
  data: {stim_id: 'EC18'}
  },
  {sentence: '<b>Est-ce que adorez vous la musique?</b>', 
  data: {stim_id: 'EC19'}
  },
  {sentence: '<b>Tu vas visite Paris avec Lisa en avril.</b>', 
  data: {stim_id: 'EC20'}
  }
]



var EC_instructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: '<p style = "font-size: 30px"><b>Error Correction Task</b></p><p class = "instructions"><b>Objective</b><br>Locate and correct grammatical errors in French sentences.<br><br><b>Procedure</b><br>You will see 20 sentences, one at a time. The written version of the sentence will remain on the screen.<br><br>Each sentence will contain <b>ONE</b> grammatical error. Your goal is to (1) identify the error and (2) correct the error. You will have <b>1 minute</b> for each sentence.',
choices: ['Continue to Example']
}


EC_prompts = [{prompt: 'What is the error?', required: true}, 
{prompt: 'What is the correction?', required: true}]

EC_demo_html = '<p>What is the error? <input readonly type = "text" id = "demo_error" name = "demo_response" placeholder = "on"/></p>' +
'<p>What is the correction? <input readonly type = "text" id = "demo_correction" name = "demo_response" placeholder = "at"/></p>'

EC_html = '<p>What is the error? <input type = "text" name = "error"/></p><p>What is the correction? <input type = "text" name = "correction"/></p>'

var EC_demo = {
  timeline:[
  {type: jsPsychSurveyHtmlForm,
  html: EC_demo_html,
  preamble: '<i>Please follow this example when answering the questions.<br>Press continue when you are ready to begin.</i><br><br><br><b>The students are meeting on the library at 5pm.</b><br><br>'
},
{type: jsPsychHtmlButtonResponse,
  stimulus: 'Try your best to answer all of the questions. Do not give up!<br><br>Do not use online dictionaries or reference tools.<br><br>We are interested in what <i>you</i> know!',
  choices:['Begin']
}
]
}


var EC_trials = {
  timeline:[

  {type: jsPsychHtmlButtonResponse,
    stimulus: 'Click Next to proceed to the next sentence.<br>',
    choices: ["Next"]},

    // need to update this to match the htmlButtonResponse
  {
  type: jsPsychSurveyHtmlFormTO,
  data: jsPsych.timelineVariable('data'),
  html: EC_html.concat('<span id = "clock" style = "color:red">-:--</span><br>'),
  preamble: jsPsych.timelineVariable('sentence'),
  trial_duration: 61000, //duration of each question is 1 minute +  1000ms buffer
  on_start: function(){
    countdown_timer(61000)
  }
},
], timeline_variables: EC_timeline_stimuli, randomize_order: true
}


 const end = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: 'You have completed the test, thank you! Please press the spacebar to end the test and be forwarded to XXXX!',
  choices: ' '
 }
 

// define the timeline order

// all the prep stuff
const fixed_start = [
get_subject, 
refresh_warning, 
prepare_microphone, 
ready_microphone,
test_audio_instructions, 
test_audio, 
recording_passed, 
enter_fullscreen
];

const park_narration_timeline = [
SC1_preload,
SC1_instructions,
no_cheating,
SC1_trials
];

const jules_timeline = [
SC2_preload,
SC2_instructions,
no_cheating,
SC2_trials
];

const samantha_timeline = [
SC3_preload,
SC3_instructions,
no_cheating,
SC3_trials
];

const dct_timeline = [
CA_preload,
CA_instructions1,
CA_instructions2,
no_cheating,
CA_example,
CA_trials
];

const cloze_timeline = [
CT_instructions,
no_cheating,
CT_trials
]

const ec_timeline = [
EC_instructions,
no_cheating,
EC_demo,
EC_trials
];

const question_blocks = jsPsych.randomization.shuffle([park_narration_timeline, jules_timeline, samantha_timeline, dct_timeline, cloze_timeline, ec_timeline]);

// dunno what to do with this: 
//timeline.push(SC_task_instructions)

// spread operator to push the new arrays
timeline.push(
...fixed_start,
...question_blocks.pop(), 
five_minute_break1, 
...question_blocks.pop(), 
five_minute_break2, 
...question_blocks.pop(), 
five_minute_break3,
...question_blocks.pop(), 
five_minute_break4,
...question_blocks.pop(), 
five_minute_break5,
...question_blocks.pop(),
end)
 
jsPsych.run(timeline);
</script>