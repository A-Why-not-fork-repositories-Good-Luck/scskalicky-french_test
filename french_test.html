<!DOCTYPE html>
<html>
  <head>
  <title>French Test</title>
  <script type = "text/javascript" src="jquery-3.6.0.js"></script>
  <script id = 'stimuli'></script>
  <script>
  var stable = "stimuli.js?="
  var dynamic = Date.now()
  var parent = document.getElementById("stimuli")
  var someScriptElement = document.createElement("script")
  someScriptElement.setAttribute("src", stable + dynamic)
  stimuli.appendChild(someScriptElement)
  </script>
  <script id = "helper"></script>
  <script>
    // force reload of stimuli pages (for development.)
    var stable = "helper_functions.js?="
    var dynamic = Date.now()
    var parent = document.getElementById("helper")
    var someScriptElement = document.createElement("script")
    someScriptElement.setAttribute("src", stable + dynamic)
    helper.appendChild(someScriptElement)
    </script>
  <script src = "jspsych/jspsych.js"></script>
  <script src = "jspsych/plugin-html-keyboard-response.js"></script>
  <script src = "jspsych/plugin-initialize-microphone.js"></script>
  <script src = "jspsych/plugin-html-audio-response.js"></script>
  <script src = "jspsych/plugin-audio-keyboard-response.js"></script>
  <script src = "jspsych/plugin-html-button-response.js"></script>
  <script src = "jspsych/plugin-instructions.js"></script>
  <script src = "jspsych/plugin-cloze19.js"></script>
  <script src = "jspsych/plugin-survey-text.js"></script>
  <script src="jspsych/plugin-preload.js"></script>
  <link href = "jspsych/jspsych.css" rel="stylesheet" type = "text/css" />
 <!--  <script src = 'stimuli.js' type = 'text/javascript'></script>-->

   
  </head>
  
  <body></body>
  
  <script>




  const jsPsych = initJsPsych({
    on_finish: function(data){
      jsPsych.data.displayData();
     // console.log('finished')
      // save data to csv
      saveData(jsPsych.data.get().select('subject').values[0].Q0, jsPsych.data.get().csv())
     // window.location = "https://www.duolingo.com";
    }
  });
  </script>
</html>

<script>

const timeline = []

var preload = {
    type: jsPsychPreload,
    auto_preload: true
}

timeline.push(preload)

var get_subject = {
  type: jsPsychSurveyText,
  questions: [{prompt: 'Please enter subject id'}],
  on_finish: function(data){
    jsPsych.data.addProperties({subject: data.response})
    console.log(jsPsych.data.get().select('subject').values[0].Q0)
    //jsPsych.data.get().select('subject')[0].values[0].Q0
  }
}

timeline.push(get_subject)

/* activate microphone and ensure participants can hear themselves being recorded.  */

// explain microphone connection
const prepare_microphone = {
    type: jsPsychHtmlButtonResponse,
    stimulus: 'Please connect your microphone to the computer. <br> We recommend using a pair of headphones with a microphone. <br>Once you have connected your microphone & headphones to the computer, click this button to prompt browser access to your microphone',
    choices: ['Add Microphone'],
}
//timeline.push(prepare_microphone)

// prompt for permission and initialise microphone
const ready_microphone = {
    type: jsPsychInitializeMicrophone
}
//timeline.push(ready_microphone)

// explain to participants they need to make sure they can hear themselves. 
const test_audio_instructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: 'Let\'s make sure the test can hear you. Please click the button below and speak into your microphone for a few seconds. <br> Afterwards, you will be able to pleay your recording. <br>Please make sure that you can hear your recording. If not, please make sure you microphone is working properly and try again. <br> Please do not continue the test until you are able to hear a recording of yourself played back to you.',
  choices: ['Begin Recording']
}
//timeline.push(test_audio_instructions)

// allow recording and playback, recording limited to 10 seconds. 
const test_audio = {
    type: jsPsychHtmlAudioResponse,
    recording_duration: 10000,
    stimulus: 'RECORDING...',
    allow_playback: true,
    show_done_button: true,
    record_again_button_label: 'Record Again',
    on_finish: function(data){
      data.response = 'sanitized'}
}
//timeline.push(test_audio)

// honor system - participants will click to move on. 
const recording_passed = {
    type: jsPsychHtmlButtonResponse,
    stimulus: 'Thank you. You have indicated that you are able to hear yourself in the recording. <br> Press Continue when you are ready to continue the test.',
    choices: ['Continue'],
}
//timeline.push(recording_passed);

/***** STORY COMPLETION BLOCK *********
These questions involve participants looking at a series of images with which they will base a story. The images will be displayed for a fixed period of time (30 seconds), after which participants will have 2 minutes to orally tell their story based on the pictures. 
*/

/***** STORY COMPLETION BLOCK *********
These questions involve participants looking at a series of images with which they will base a story. The images will be displayed for a fixed period of time (30 seconds), after which participants will have 2 minutes to orally tell their story based on the pictures. 
*/

// todo

/***** COMMUNICATIVE ADEQUACY BLOCK *********
These questions involve participants listening and responding to a sustained simulated conversation. They will listen to the recording and then be asked to record their response. They will only be able to listen to each turn once. 

- do we need a practice session? or at least one practice item to start? 

*/

// instructions for communicative adequacy
const prepare_trials = {
  type: jsPsychInstructions,
  pages: ['This test requires you to participate in some short back-and-forth conversations',
  'You will first hear a speaker say something, and then you will record your response.',
  'You will then hear the speaker reply, and you will then record your response.', 
  'The test will start recording you as soon as you click the "record response" button.', 
  'You will only hear the audio once.'],
  choices: ['LET\'S GO!'],
  on_finish: function(){console.log(baf_stim)}
}

//timeline.push(prepare_trials)

// communicative adequacy timeline. 
// define repeated trials. 

// this might need to be changes so that each label is different for the 1st, 2nd, and 3rd playing. 
const play_audio_button = {
    type: jsPsychHtmlButtonResponse,
    stimulus: '',
    choices: ['PLAY AUDIO']
};

const record_response_button = {
    type: jsPsychHtmlButtonResponse,
    stimulus: '',
  choices: ['RECORD RESPONSE']
};

const record_answer = {
    type: jsPsychHtmlAudioResponse,
    stimulus: 'RECORDING...',
    recording_duration: 5000,
    show_done_button: true,
    done_button_label: "Finish Recording",
    // save audio
    on_finish: function(data){
        //subject name
      purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
      // audio file name
      jsPsych.data.get().last(3).values()[0].stimulus.substring(6), 
      // current js data object
      data)
}}

const conversations = {
  timeline: [
  {type: jsPsychHtmlButtonResponse,
  stimulus: 'You are about to begin a NEW conversation.',
  choices: ['BEGIN']},

  play_audio_button,

  {type: jsPsychAudioKeyboardResponse,
  stimulus: jsPsych.timelineVariable('turn1'),
  data: jsPsych.timelineVariable("data"),
  choices: 'NO_KEYS',
  trial_ends_after_audio: true},
    
  record_response_button,

  record_answer,
    
  play_audio_button,

  {type: jsPsychAudioKeyboardResponse,
  stimulus: jsPsych.timelineVariable('turn2'),
  data: jsPsych.timelineVariable("data"),
  choices: 'NO_KEYS',
  trial_ends_after_audio: true},

  record_response_button,

  record_answer,

  play_audio_button,

  {type: jsPsychAudioKeyboardResponse,
  stimulus: jsPsych.timelineVariable('turn3'),
  data: jsPsych.timelineVariable("data"),
  choices: 'NO_KEYS',
  trial_ends_after_audio: true},
    
  record_response_button,

  record_answer,


  {type: jsPsychHtmlKeyboardResponse,
  stimulus: "LOADING NEXT ITEM...",
  trial_duration: 2500,
  choices: "NO_KEYS"
  }
  

 ], timeline_variables: baf_stim}

 //timeline.push(conversations)


/***** LISTENING COMPREHENSION BLOCK *********
Participants will listen to a audio dialogues in French. After the dialogues they will answer different questions:
1. Choosing from 2 English dialogues: one dialogue is the translated version, whereas the other is not. 
2. Choosing from two pictures: one picture represents information from the dialogue, and one does not. 
3. Listen to a short dialogue (twice), and then respond to written comprehension questions orally using French. There is a 30-sec
*/

//todo

/***** C-TEST *********
Participants will read three short texts. Each text will have some words missing parts of the word. Participants must type in letters in order to provide correct words. 
*/

//todo
// convert french text to ascii.

var c_test_instructions = {
  type: jsPsychInstructions,
  pages:['In this part of the test you will see a text presented on the screen.',
'In the following texts, parts of some words is missing.', 
'Please write in the missing letters to complete the words.',
'You will have 5 minutes for each text.',
'Please click Continue to see the first text.'],
show_clickable_nav: true
}

timeline.push(c_test_instructions);
//https://github.com/jspsych/jsPsych/discussions/2543

var start_time;
// how to make it end after 5 minutes? 

var c_test_trials = {
timeline:[
{type: jsPsychHtmlButtonResponse,
stimulus: 'Press "Continue" to see the text.',
choices: ['Continue'],
on_finish: function(){console.log(c_test_stim)}
},

{type: jsPsychCloze,
text: jsPsych.timelineVariable('c_text'),
trial_duration: 300000,
},

{type: jsPsychHtmlKeyboardResponse,
stimulus: 'next',
choices: [' ']}
], timeline_variables: c_test_stim
}

timeline.push(c_test_trials);



 var end = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: 'Press the spacebar to end the test',
  choices: ' '
 }
 
 timeline.push(end)
 

jsPsych.run(timeline);
</script>