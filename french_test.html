<!DOCTYPE html>
<html>
  <head>
  <title>French Test</title>
  <script src = "jspsych/jspsych.js"></script>
  <script src = "jspsych/plugin-html-keyboard-response.js"></script>
  <script src = "jspsych/plugin-initialize-microphone.js"></script>
  <script src = "jspsych/plugin-html-audio-response.js"></script>
  <script src = "jspsych/plugin-audio-keyboard-response.js"></script>
  <script src = "jspsych/plugin-html-button-response.js"></script>
  <script src="jspsych/plugin-preload.js"></script>
  <script type="text/javascript" src="jquery-3.6.0.js"></script>
  <link href = "jspsych/jspsych.css" rel="stylesheet" type = "text/css" />
  </head>
  <body></body>
  <script>
  const jsPsych = initJsPsych({
    on_finish: function(data){
      //jsPsych.data.displayData();
     // console.log('finished')
      // save data to csv
      saveData(id, jsPsych.data.get().csv())
    }
  });
  </script>
</html>

<script>

//random id for testing
const id = jsPsych.randomization.sampleWithoutReplacement(['Stephen', 'stephen'], 1)
console.log(id);

jsPsych.data.addProperties({subject: id})

// save all data at the end
function saveData(name, data){
  var xhr = new XMLHttpRequest();
  xhr.open('POST', 'write_data.php');
  xhr.setRequestHeader('Content-Type', 'application/json');
  xhr.send(JSON.stringify({filedata: data}));
}




const timeline = []

var preload = {
    type: jsPsychPreload,
    auto_preload: true
}
timeline.push(preload)

const preamble = {
    type: jsPsychHtmlButtonResponse,
    stimulus: 'Please connect your microphone to the computer. <br> We recommend using a pair of headphones with a microphone. <br>Once you have connected your microphone & headphones to the computer, click this button to prompt browser access to your microphone',
    choices: ['Add Microphone']
}

timeline.push(preamble)

const ready_microphone = {
    type: jsPsychInitializeMicrophone
}

timeline.push(ready_microphone)

const test_audio = {
    type: jsPsychHtmlButtonResponse,
    stimulus: 'Please test your audio now. Record yourself and then listen to the recording to make sure the test is capturing your audio.',
    allow_playback: true,
    recording_duration: 4000,
    show_done_button: true,
    record_again_button_label: 'Record Again'
}

timeline.push(test_audio)

const welcome_trial = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: 'This a test of recording audio for our French test. <br>Press the spacebar.',
    choices: ' '
}

timeline.push(welcome_trial);




const warn_audio = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: 'Press the space bar to hear the audio',
  choices: [' ']
}

timeline.push(warn_audio)



var present_audio = {
  type: jsPsychAudioKeyboardResponse,
  stimulus: 'audio/fiona1.mp3',
  choices: 'NO_KEYS',
  trial_ends_after_audio: true
}

timeline.push(present_audio)

const prepare_response = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: 'Press the space bar to record your response',
  choices: [' ']
}

timeline.push(prepare_response)


var record_voice = {
    type: jsPsychHtmlAudioResponse,
    stimulus: 'What would you say? (5 seconds of recording time)',
    recording_duration: 5000,
    show_done_button: true,
    done_button_label: "Finish Recording",
    // save the audio to the server then remove from active data object
    // this is necessary because the audio data takes up much memory
    on_finish: function(data){
      // create a random id for the specific audio file.
      audio_id = (id).toString().concat('_audio-').concat(Date.now().toString().concat('_').concat(Math.floor(Math.random()*9999)).toString())
      console.log(audio_id);
      // call the php script
      $.ajax ({
						url: "save_audio.php",
						type: "POST",
						data: {audio_base64: data.response, identifier: audio_id},
            dataType: 'text',
          });
     // replace the base64 in the jsP data with the audio_id
    data.response = audio_id;
    }}
    
timeline.push(record_voice)


jsPsych.run(timeline);
</script>