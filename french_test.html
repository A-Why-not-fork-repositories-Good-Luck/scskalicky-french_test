<!DOCTYPE html>
<html>
  <head>
  <title>French Test</title>
  <script type = "text/javascript" src="jquery-3.6.0.js"></script>
  <script id = 'stimuli'></script>
  <script>
  var stable = "stimuli.js?="
  var dynamic = Date.now()
  var parent = document.getElementById("stimuli")
  var someScriptElement = document.createElement("script")
  someScriptElement.setAttribute("src", stable + dynamic)
  stimuli.appendChild(someScriptElement)
  </script>
  <script id = "helper"></script>
  <script>
    // force reload of stimuli pages (for development.)
    var stable = "helper_functions.js?="
    var dynamic = Date.now()
    var parent = document.getElementById("helper")
    var someScriptElement = document.createElement("script")
    someScriptElement.setAttribute("src", stable + dynamic)
    helper.appendChild(someScriptElement)
    </script>
  <script src = "jspsych/jspsych.js"></script>
  <script src = "jspsych/plugin-html-keyboard-response.js"></script>
  <script src = "jspsych/plugin-initialize-microphone.js"></script>
  <script src = "jspsych/plugin-html-audio-response.js"></script>
  <script src = "jspsych/plugin-audio-keyboard-response.js"></script>
  <script src = "jspsych/plugin-html-button-response.js"></script>
  <script src = "jspsych/plugin-survey-text.js"></script>
  <script src="jspsych/plugin-preload.js"></script>
  <link href = "jspsych/jspsych.css" rel="stylesheet" type = "text/css" />
  <script src = 'stimuli.js' type = 'text/javascript'></script>

   
  </head>
  
  <body></body>
  
  <script>

  const jsPsych = initJsPsych({
    on_finish: function(data){
      //jsPsych.data.displayData();
     // console.log('finished')
      // save data to csv
      saveData(jsPsych.data.get().select('subject')[0].values[0].Q0, jsPsych.data.get().csv())
     // window.location = "https://www.duolingo.com";
    }
  });
  </script>
</html>

<script>

const timeline = []

var preload = {
    type: jsPsychPreload,
    auto_preload: true
}

//timeline.push(preload)

var get_subject = {
  type: jsPsychSurveyText,
  questions: [{prompt: 'Please enter subject id'}],
  on_finish: function(data){
    jsPsych.data.addProperties({subject: data.response})
    var subject = console.log(jsPsych.data.get().select('subject').values[0].Q0)
    console.log(subject)
  }
}

timeline.push(get_subject)

const preamble = {
    type: jsPsychHtmlButtonResponse,
    stimulus: 'Please connect your microphone to the computer. <br> We recommend using a pair of headphones with a microphone. <br>Once you have connected your microphone & headphones to the computer, click this button to prompt browser access to your microphone',
    choices: ['Add Microphone'],
}

//timeline.push(preamble)

const ready_microphone = {
    type: jsPsychInitializeMicrophone
}

//timeline.push(ready_microphone)

const test_audio_instructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: 'Let\'s make sure the test can hear you. Please click the button below and speak into your microphone. <br> You will be able to review your recording afterwards. <br> Please do not continue the test until you are able to hear a recording of yourself played back to you.',
  choices: ['Begin Recording']
}

//timeline.push(test_audio_instructions)

const test_audio = {
    type: jsPsychHtmlAudioResponse,
    recording_duration: 10000,
    stimulus: 'RECORDING...',
    allow_playback: true,
    show_done_button: true,
    record_again_button_label: 'Record Again',
    on_finish: function(data){
      data.response = 'sanitized'}
}


//timeline.push(test_audio)

const recording_passed = {
    type: jsPsychHtmlButtonResponse,
    stimulus: 'Thank you. You have indicated that you are able to hear the recording played back to you. <br> Press the button to continue the test.',
    choices: ['Continue'],
}

timeline.push(recording_passed);


const prepare_trials = {
  type: jsPsychHtmlButtonResponse,
  stimulus: 'This test requires you to participate in some short back-and-forth conversations. You will first hear a speaker say something, and then you will record your response. You will then hear the speaker reply, and you will then record your response. The test will start recording you as soon as you click the "record response" button. You will only hear the audio once.',
  choices: ['LET\'S GO!'],
  on_finish: function(){console.log(baf_stim)}
}

//timeline.push(prepare_trials)

// conversation trials timeline. 

// define repeated trials. 
const play_audio_button = {
    type: jsPsychHtmlButtonResponse,
    stimulus: '',
    choices: ['PLAY AUDIO']
};

const record_response_button = {
    type: jsPsychHtmlButtonResponse,
    stimulus: '',
  choices: ['RECORD RESPONSE']
};

const record_answer = {
    type: jsPsychHtmlAudioResponse,
    stimulus: 'RECORDING...',
    recording_duration: 5000,
    show_done_button: true,
    done_button_label: "Finish Recording",
    // save audio
    on_finish: function(data){
        //subject name
      purgeAudio(jsPsych.data.get().select('subject').values[0].Q0,
      // audio file name
      jsPsych.data.get().last(3).values()[0].stimulus.substring(6), 
      // current js data object
      data)
}}



const conversations = {
  timeline: [
  {type: jsPsychHtmlButtonResponse,
  stimulus: 'You are about to begin a NEW conversation.',
  choices: ['BEGIN']},

  play_audio_button,

  {type: jsPsychAudioKeyboardResponse,
  stimulus: jsPsych.timelineVariable('turn1'),
  data: jsPsych.timelineVariable("data"),
  choices: 'NO_KEYS',
  trial_ends_after_audio: true},
    
  record_response_button,

  record_answer,
    
  play_audio_button,

  {type: jsPsychAudioKeyboardResponse,
  stimulus: jsPsych.timelineVariable('turn2'),
  data: jsPsych.timelineVariable("data"),
  choices: 'NO_KEYS',
  trial_ends_after_audio: true},

  record_response_button,

  record_answer,

  play_audio_button,

  {type: jsPsychAudioKeyboardResponse,
  stimulus: jsPsych.timelineVariable('turn3'),
  data: jsPsych.timelineVariable("data"),
  choices: 'NO_KEYS',
  trial_ends_after_audio: true},
    
  record_response_button,

  record_answer,


  {type: jsPsychHtmlKeyboardResponse,
  stimulus: "LOADING NEXT ITEM...",
  trial_duration: 2500,
  choices: "NO_KEYS"
  }
  

 ], timeline_variables: baf_stim}

 //timeline.push(conversations)

 var end = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: 'Press the spacebar to end the test',
  choices: ' '
 }
 
 timeline.push(end)
 

jsPsych.run(timeline);
</script>